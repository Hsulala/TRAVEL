<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TOKYO TRIP</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#e5e5e5">

    <!-- iPhone Icon -->
    <link rel="apple-touch-icon" href="logo.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');

        body { 
            font-family: 'Barlow', 'Noto Sans TC', sans-serif;
            background-color: #e5e5e5; 
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            color: #1c1917;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; position: relative; background-color: transparent; padding-bottom: 80px; }
        ::-webkit-scrollbar { display: none; }

        .card-marble {
            background-color: #ffffff;
            border: 3px solid #1c1917;
            border-radius: 20px;
            box-shadow: 6px 6px 0px #1c1917;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .card-marble-sm {
            background-color: #ffffff;
            border: 2px solid #1c1917;
            border-radius: 12px;
            box-shadow: 3px 3px 0px #1c1917;
        }
        
        .menu-icon {
            display: flex; flex-direction: column; align-items: flex-start; justify-content: center; padding: 1.2rem; height: 130px; position: relative; overflow: hidden;
        }
        .menu-icon:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #1c1917; }
        .menu-icon i { width: 28px; height: 28px; margin-bottom: 8px; color: #1c1917; stroke-width: 2.5px; }
        .menu-icon span { font-weight: 900; text-transform: uppercase; font-size: 1.1rem; letter-spacing: 0.5px; line-height: 1; }
        .menu-icon .subtitle { font-size: 0.7rem; font-weight: 700; color: #78716c; margin-top: 4px; }

        .hidden-view { display: none; }
        .active-view { display: block; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

        .timeline-item { position: relative; }
        .timeline-line { position: absolute; left: 19px; top: 24px; bottom: -10px; width: 3px; background: #d6d3d1; z-index: 0; }
        .timeline-dot { position: absolute; left: 11px; top: 24px; width: 19px; height: 19px; background: #1c1917; border: 3px solid #f97316; border-radius: 50%; z-index: 10; }
        .timeline-content-wrapper { padding-left: 50px; position: relative; }
        
        .sortable-ghost { opacity: 0.2; background: #e7e5e4; border: 2px dashed #1c1917; }
        .sortable-drag { opacity: 0.9; transform: scale(1.02); z-index: 50; background: white; }
        
        .drag-handle { touch-action: none; cursor: grab; padding: 8px; color: #d6d3d1; }
        .drag-handle:active { cursor: grabbing; color: #f97316; }
        
        .memo-content { white-space: pre-wrap; word-break: break-word; font-size: 0.9rem; line-height: 1.5; color: #44403c; }

        .fab-calc {
            position: fixed; bottom: 40px; right: 20px; width: 64px; height: 64px; border-radius: 50%;
            background: #f97316; border: 3px solid #1c1917; color: white;
            display: none; align-items: center; justify-content: center;
            box-shadow: 4px 4px 0px #1c1917; z-index: 50; transition: transform 0.1s;
        }
        .fab-calc:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #1c1917; }

        .flow-btn-container { margin-top: 30px; margin-bottom: 20px; display: flex; justify-content: center; width: 100%; }
        
        .big-action-btn {
            pointer-events: auto; cursor: pointer; width: 100%; padding: 16px;
            border-radius: 50px; font-weight: 900; font-size: 18px; border: 3px solid #1c1917;
            display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1); transition: transform 0.1s;
            background: #1c1917; color: white;
        }
        .big-action-btn:active { transform: scale(0.98); box-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        .btn-orange { background: #f97316; border-color: #c2410c; color: white; }

        .header-bar { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; }
        .back-btn { width: 40px; height: 40px; border: 2px solid #1c1917; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 2px 2px 0px #1c1917; }
        
        .date-tab { flex-shrink: 0; width: 60px; height: 64px; border: 2px solid #1c1917; background: white; color: #1c1917; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; cursor: pointer; transition: all 0.2s; box-shadow: 3px 3px 0px #a8a29e; border-radius: 12px; }
        .date-tab.active { background: #1c1917; color: #f97316; box-shadow: 3px 3px 0px #f97316; transform: translate(-1px, -1px); }
        
        .checkbox-custom { 
            appearance: none; width: 24px; height: 24px; border: 2px solid #1c1917; background: white; 
            display: grid; place-content: center; cursor: pointer; flex-shrink: 0; border-radius: 6px; 
        }
        .checkbox-custom::before { 
            content: ""; width: 14px; height: 14px; transform: scale(0); transition: 0.1s transform ease-in-out; 
            background: #1c1917; border-radius: 2px;
        }
        .checkbox-custom:checked::before { transform: scale(1); }
        .checkbox-custom:checked { background: #e5e5e5; border-color: #78716c; }
        .checkbox-custom:checked::before { background: #78716c; }

        .item-checked { opacity: 0.5; order: 999; }
        .item-checked span { text-decoration: line-through; }

        dialog { border-radius: 24px; border: none; padding: 0; background: transparent; width: 90%; max-width: 400px; z-index: 100; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(3px); z-index: 99; }
        
        .pet-frame { position: relative; overflow: hidden; background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out; }
        .pet-frame::after { content: ""; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); }
    </style>
</head>
<body>

<div id="error-toast" style="display:none; position:fixed; top:0; left:0; right:0; background:red; color:white; padding:10px; z-index:9999; font-size:12px; font-weight:bold; text-align:center;"></div>

<div class="app-container p-4">
    
    <!-- 0. È¶ñÈ†Å -->
    <div id="view-home" class="active-view">
        <header class="mb-6 mt-4 flex justify-between items-start">
            <div>
                <div class="text-xs font-black tracking-[0.2em] text-orange-600 mb-1">TRAVEL PLANNER</div>
                <h1 class="text-5xl font-black text-stone-900 tracking-tighter italic">TOKYO<span class="text-orange-500">.</span></h1>
                <div class="flex items-center mt-2 text-xs font-bold text-stone-500">
                    <div id="auth-status-dot" class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    <span id="auth-status-text">ONLINE</span>
                </div>
            </div>
            <button onclick="window.app && window.app.openCalculator()" style="width:56px; height:56px; background:#f97316; color:white; border:2px solid #1c1917; border-radius:16px; box-shadow:3px 3px 0 #1c1917; display:flex; align-items:center; justify-content:center;" class="active:translate-y-1 active:shadow-none transition-all">
                <i data-lucide="calculator" class="w-7 h-7"></i>
            </button>
        </header>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="window.app && window.app.switchView('itinerary')" class="card-marble col-span-2 flex flex-row gap-4 items-center p-6 h-40 bg-stone-50 hover:bg-stone-100 relative overflow-hidden active:scale-95 transition-transform">
                <div class="bg-stone-900 text-white p-4 rounded-full border-2 border-stone-900 z-10 w-16 h-16 flex items-center justify-center mb-4">
                    <i data-lucide="map" class="w-8 h-8 !text-white !m-0"></i>
                </div>
                <div class="flex-grow text-left z-10">
                    <span class="block text-4xl font-black tracking-tighter text-stone-900">ITINERARY</span>
                </div>
                <i data-lucide="arrow-right" class="w-8 h-8 z-10 text-stone-900 absolute bottom-6 right-6"></i>
                <div class="absolute -right-10 -top-10 w-48 h-48 bg-orange-500 rounded-full opacity-10 z-0"></div>
            </button>

            <button onclick="window.app && window.app.switchView('wishlist')" class="card-marble menu-icon hover:bg-stone-100 bg-white active:bg-stone-200">
                <i data-lucide="heart"></i>
                <span class="text-stone-900">WISHLIST</span>
                <div class="subtitle">ÊÖæÊúõÊ∏ÖÂñÆ</div>
            </button>

            <button onclick="window.app && window.app.switchView('packing')" class="card-marble menu-icon hover:bg-stone-100 bg-white active:bg-stone-200">
                <i data-lucide="luggage"></i>
                <span class="text-stone-900">PACKING</span>
                <div class="subtitle">Ë°åÊùéÊ∏ÖÂñÆ</div>
            </button>

            <button onclick="window.app && window.app.switchView('mustbuy')" class="card-marble menu-icon hover:bg-stone-100 bg-white active:bg-stone-200">
                <i data-lucide="shopping-bag"></i>
                <span class="text-stone-900">MUST BUY</span>
                <div class="subtitle">ÂøÖË≤∑Ê∏ÖÂñÆ</div>
            </button>
            
            <div id="pet-frame" class="card-marble menu-icon pet-frame p-0 border-dashed border-stone-400 bg-stone-200">
                <div class="absolute bottom-3 left-3 text-white font-bold text-xs z-10 flex items-center drop-shadow-md">
                    <i data-lucide="heart" class="w-3 h-3 mr-1 fill-orange-500 text-orange-500"></i> My Pets
                </div>
            </div>
        </div>
    </div>

    <!-- 1. Ë°åÁ®ã -->
    <div id="view-itinerary" class="hidden-view">
        <div class="header-bar sticky top-0 bg-[#e5e5e5] z-20 pt-2">
            <button onclick="window.app.goHome()" class="back-btn"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h2 class="font-black text-2xl tracking-tight text-stone-900">ITINERARY</h2>
            <div class="flex gap-2 bg-white/80 backdrop-blur p-1.5 rounded-2xl border-2 border-stone-200">
                <button onclick="window.app.switchView('wishlist')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="heart" class="w-5 h-5"></i></button>
                <button onclick="window.app.switchView('mustbuy')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="shopping-bag" class="w-5 h-5"></i></button>
            </div>
        </div>

        <div id="nav-dates" class="flex overflow-x-auto gap-3 pb-4 mb-2"></div>

        <div id="section-memo" class="hidden">
             <div id="list-memo" class="space-y-4"></div>
             <div class="flow-btn-container">
                 <button onclick="window.app.openMemoModal()" class="big-action-btn">
                    <i data-lucide="sticky-note" class="w-5 h-5"></i> Êñ∞Â¢ûÂÇôÂøò
                 </button>
            </div>
        </div>

        <div id="section-itinerary" class="pt-4">
            <div id="list-itinerary" class="pl-2 relative space-y-6 min-h-[200px]"></div>
            
            <div id="btn-itin-add-container" class="flow-btn-container">
                 <button onclick="window.app.openItineraryModal()" class="big-action-btn btn-orange">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Êñ∞Â¢ûË°åÁ®ã
                 </button>
            </div>
        </div>
    </div>

    <!-- 2. Ë°åÊùé -->
    <div id="view-packing" class="hidden-view">
        <div class="header-bar sticky top-0 bg-[#e5e5e5] z-20 pt-2">
            <button onclick="window.app.goHome()" class="back-btn"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h2 class="font-black text-2xl tracking-tight text-stone-900">PACKING</h2>
            <div class="flex gap-2 bg-white/80 backdrop-blur p-1.5 rounded-2xl border-2 border-stone-200">
                <button onclick="window.app.switchView('itinerary')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="map" class="w-5 h-5"></i></button>
            </div>
        </div>
        <div id="packing-container" class="space-y-6"></div>

        <div class="flow-btn-container">
             <button onclick="document.getElementById('dialog-packing').showModal()" class="big-action-btn hover:bg-stone-100 transition-colors">
                <i data-lucide="package-plus" class="w-5 h-5"></i> Êñ∞Â¢ûÁâ©ÂìÅ
             </button>
        </div>
    </div>

    <!-- 3. ÊÖæÊúõÊ∏ÖÂñÆ -->
    <div id="view-wishlist" class="hidden-view">
        <div class="header-bar sticky top-0 bg-[#e5e5e5] z-20 pt-2">
            <button onclick="window.app.goHome()" class="back-btn"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h2 class="font-black text-2xl tracking-tight text-stone-900">WISHLIST</h2>
            <div class="flex gap-2 bg-white/80 backdrop-blur p-1.5 rounded-2xl border-2 border-stone-200">
                <button onclick="window.app.switchView('itinerary')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="map" class="w-5 h-5"></i></button>
                <button onclick="window.app.switchView('mustbuy')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="shopping-bag" class="w-5 h-5"></i></button>
            </div>
        </div>

        <div id="list-wishlist" class="space-y-6"></div>

        <div class="flow-btn-container">
             <button onclick="window.app.openWishlistModal()" class="big-action-btn hover:bg-stone-100 transition-colors">
                <i data-lucide="heart-handshake" class="w-5 h-5"></i> Êñ∞Â¢ûÊÖæÊúõ
             </button>
        </div>
    </div>

    <!-- 4. ÂøÖË≤∑Ê∏ÖÂñÆ -->
    <div id="view-mustbuy" class="hidden-view">
        <div class="header-bar sticky top-0 bg-[#e5e5e5] z-20 pt-2">
            <button onclick="window.app.goHome()" class="back-btn"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h2 class="font-black text-2xl tracking-tight text-stone-900">MUST BUY</h2>
            <div class="flex gap-2 bg-white/80 backdrop-blur p-1.5 rounded-2xl border-2 border-stone-200">
                <button onclick="window.app.switchView('itinerary')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="map" class="w-5 h-5"></i></button>
                <button onclick="window.app.switchView('wishlist')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="heart" class="w-5 h-5"></i></button>
            </div>
        </div>
        
        <div id="list-mustbuy" class="space-y-3"></div>

        <div class="flow-btn-container">
             <button onclick="window.app.openMustBuyModal()" class="big-action-btn hover:bg-stone-100 transition-colors">
                <i data-lucide="shopping-cart" class="w-5 h-5"></i> Êñ∞Â¢ûÂøÖË≤∑
             </button>
        </div>
    </div>

</div>

<!-- FAB (Á¥îË®àÁÆóÊ©ü) -->
<button id="fab-calc" onclick="window.app && window.app.openCalculator()" class="fab-calc hidden">
    <i data-lucide="calculator" class="w-8 h-8"></i>
</button>

<!-- ÈåØË™§ÊèêÁ§∫ -->
<dialog id="dialog-alert" class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-4 border-stone-900 w-80">
    <div class="text-center">
        <h3 class="font-black text-xl text-stone-900 mb-2">NOTICE</h3>
        <p id="alert-msg" class="text-stone-600 text-sm font-bold mb-6"></p>
        <button onclick="document.getElementById('dialog-alert').close()" class="w-full py-3 font-black text-white bg-stone-900 rounded-xl">OK</button>
    </div>
</dialog>

<!-- Ë®àÁÆóÊ©ü -->
<dialog id="dialog-calculator">
    <div class="bg-white rounded-[24px] p-4 m-2 shadow-2xl border-4 border-stone-900">
        <div class="flex justify-between items-center mb-4">
            <div class="text-xs font-black text-stone-400 uppercase tracking-widest">Rate Calc</div>
            <button type="button" onclick="document.getElementById('dialog-calculator').close()" class="p-2 bg-stone-100 rounded-full active:bg-stone-200"><i data-lucide="x" class="w-5 h-5 text-stone-600"></i></button>
        </div>
        <div class="bg-stone-100 rounded-xl px-3 py-4 mb-4 text-right border-2 border-stone-200">
            <div class="flex justify-between items-baseline mb-1">
                 <span class="text-sm font-black text-stone-400" id="calc-input-unit">JPY</span>
                 <input type="text" id="calc-display" class="bg-transparent text-5xl font-black text-right outline-none text-stone-900 tracking-tighter w-full" placeholder="0" readonly>
            </div>
            <div class="text-stone-500 font-bold text-lg border-t border-stone-200 pt-2 flex justify-end items-center gap-2">
                <span class="text-[10px] bg-orange-100 text-orange-600 px-1 rounded" id="calc-output-unit">TWD</span>
                <span>‚âà <span id="calc-res">0</span></span>
            </div>
        </div>
        <button type="button" onclick="window.app.toggleCurrency()" style="width:100%; font-size:12px; font-weight:bold; background:#f5f5f4; padding:8px; border-radius:12px; color:#78716c; display:flex; align-items:center; justify-content:center; border:2px solid #e7e5e4; margin-bottom:12px;">
            <span id="calc-mode-text">JPY ‚Üí TWD</span> <i data-lucide="arrow-left-right" class="w-3 h-3 ml-2"></i>
        </button>
        <div class="grid grid-cols-4 gap-2">
            <button style="height:70px; border-radius:12px; background:white; color:#1c1917; font-size:24px; font-weight:900; border:2px solid #1c1917; box-shadow:2px 2px 0 #1c1917;" onclick="window.app.calcAppend('7')">7</button>
            <button style="height:70px; border-radius:12px; background:white; color:#1c1917; font-size:24px; font-weight:900; border:2px solid #1c1917; box-shadow:2px 2px 0 #1c1917;" onclick="window.app.calcAppend('8')">8</button>
            <button style="height:70px; border-radius:12px; background:white; color:#1c1917; font-size:24px; font-weight:900; border:2px solid #1c1917; box-shadow:2px 2px 0 #1c1917;" onclick="window.app.calcAppend('9')">9</button>
            <button style="height:70px; border-radius:12px; background:#fff7ed; color:#f97316; font-size:20px; font-weight:900; border:2px solid #1c1917; box-shadow:2px 2px 0 #1c1917;" onclick="window.app.calcDel()"><i data-lucide="delete" class="w-6 h-6 mx-auto"></i></button>
            <button style="height:70px; border-radius:12px; background:white; color:#1c1917; font-size:24px; font-weight:900; border:2px solid #1c1917;" onclick="window.app.calcAppend('4')">4</button>
            <button style="height:70px; border-radius:12px; background:white; color:#1c1917; font-size:24px; font-weight:900; border:2px solid #1c1917;" onclick="window.app.calcAppend('5')">5</button>
            <button style="height:70px; border-radius:12px; background:white; color:#1c1917; font-size:24px; font-weight:900; border:2px solid #1c1917;" onclick="window.app.calcAppend('6')">6</button>
            <button style="height:70px; border-radius:12px; background:#fff7ed; color:#f97316; font-size:24px; font-weight:900; border:2px solid #1c1917;" onclick="window.app.calcClear()">C</button>
            <button style="height:70px; border-radius:12px; background:white; color:#1c1917; font-size:24px; font-weight:900; border:2px solid #1c1917;" onclick="window.app.calcAppend('1')">1</button>
            <button style="height:70px; border-radius:12px; background:white; color:#1c1917; font-size:24px; font-weight:900; border:2px solid #1c1917;" onclick="window.app.calcAppend('2')">2</button>
            <button style="height:70px; border-radius:12px; background:white; color:#1c1917; font-size:24px; font-weight:900; border:2px solid #1c1917;" onclick="window.app.calcAppend('3')">3</button>
            <button style="height:70px; border-radius:12px; background:white; color:#1c1917; font-size:24px; font-weight:900; border:2px solid #1c1917;" onclick="window.app.calcAppend('.')">.</button>
            <button style="height:70px; border-radius:12px; background:white; color:#1c1917; font-size:24px; font-weight:900; border:2px solid #1c1917; grid-column: span 4;" onclick="window.app.calcAppend('0')">0</button>
        </div>
    </div>
</dialog>

<!-- ÂÇôÂøòÈåÑ -->
<dialog id="dialog-memo">
    <div class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-2 border-stone-200">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-black text-xl text-stone-800">MEMO</h3>
            <button type="button" onclick="document.getElementById('dialog-memo').close()" class="p-2 bg-stone-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <form id="form-memo" onsubmit="event.preventDefault(); window.app.saveMemo()" class="space-y-4">
            <input type="hidden" id="memo-id">
            <input type="text" id="memo-title" placeholder="Ê®ôÈ°å (‰æã: ÊªëÈõ™È†àÁü•)" class="w-full bg-stone-50 p-4 rounded-xl font-black text-lg outline-none border-2 border-stone-200 focus:border-stone-900" required>
            <textarea id="memo-content" placeholder="ÂÖßÂÆπ (ÊîØÊè¥ÊèõË°å)..." class="w-full bg-stone-50 p-4 rounded-xl text-sm outline-none border-2 border-stone-200 focus:border-stone-900 h-60"></textarea>
            <button type="submit" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg shadow-[4px_4px_0px_#f97316] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all border-2 border-stone-900">SAVE</button>
        </form>
    </div>
</dialog>

<!-- Ë°åÁ®ã -->
<dialog id="dialog-itinerary">
    <div class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-2 border-stone-200 relative">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-black text-xl text-stone-800">EDIT PLAN</h3>
            <div class="flex gap-2">
                 <button type="button" onclick="window.app.deleteItinerary()" id="btn-del-itin" class="hidden p-3 bg-red-50 text-red-500 rounded-full hover:bg-red-100 border border-red-100 active:bg-red-200" style="z-index:999;"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                 <button type="button" onclick="document.getElementById('dialog-itinerary').close()" class="p-2 bg-stone-100 rounded-full" style="z-index:999;"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
        </div>
        <form id="form-itinerary" onsubmit="window.app.saveItinerary(event)" class="space-y-4">
            <input type="hidden" id="itin-id">
            <div class="bg-stone-50 p-3 rounded-xl border border-stone-200">
                <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">Date</label>
                <input type="date" id="itin-date" class="w-full bg-transparent font-bold text-stone-800 outline-none text-lg" required>
            </div>
            <div class="flex gap-3">
                <div class="w-1/3">
                     <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">Time</label>
                     <input type="time" id="itin-time" class="bg-stone-50 p-3 rounded-xl w-full text-center font-bold outline-none border border-stone-200 focus:border-stone-900">
                </div>
                <div class="w-1/3">
                     <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">End Time</label>
                     <input type="time" id="itin-end-time" class="bg-stone-50 p-3 rounded-xl w-full text-center font-bold outline-none border border-stone-200 focus:border-stone-900">
                </div>
                <div class="w-1/3">
                     <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">Category</label>
                     <select id="itin-cat" class="bg-stone-50 p-3 rounded-xl w-full font-bold outline-none border border-stone-200 focus:border-stone-900">
                        <option value="ÊôØÈªû">üìç ÊôØÈªû</option>
                        <option value="ÁæéÈ£ü">üç¥ ÁæéÈ£ü</option>
                        <option value="Ë≥ºÁâ©">üõçÔ∏è Ë≥ºÁâ©</option>
                        <option value="‰ΩèÂÆø">üõèÔ∏è ‰ΩèÂÆø</option>
                        <option value="‰∫§ÈÄö">üöå ‰∫§ÈÄö</option>
                        <option value="Ëà™Áè≠">‚úàÔ∏è Ëà™Áè≠</option>
                    </select>
                </div>
            </div>
            <input type="text" id="itin-title" placeholder="ÂêçÁ®± (‰æã: SHIBUYA SKY)" class="w-full bg-stone-50 p-4 rounded-xl font-black text-lg outline-none border-2 border-stone-200 focus:border-stone-900" required>
            <textarea id="itin-note" placeholder="ÂÇôË®ª (ÂèØÊèõË°å)..." class="w-full bg-stone-50 p-3 rounded-xl text-sm outline-none border border-stone-200 focus:border-stone-900 h-24 resize-none"></textarea>
            <div class="relative">
                <i data-lucide="map-pin" class="absolute left-3 top-3.5 w-4 h-4 text-stone-400"></i>
                <input type="text" id="itin-map" placeholder="Google Maps ÈÄ£Áµê (ÈÅ∏Â°´)" class="w-full bg-stone-50 p-3 pl-10 rounded-xl text-sm outline-none border border-stone-200 focus:border-stone-900 text-blue-600 font-bold">
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-grow bg-stone-900 text-white font-bold py-4 rounded-lg shadow-[4px_4px_0px_#f97316] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all border-2 border-stone-900">SAVE</button>
            </div>
        </form>
    </div>
</dialog>

<dialog id="dialog-packing">
    <div class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-2 border-stone-200">
         <div class="flex justify-between items-center mb-4">
            <h3 class="font-black text-xl text-stone-800">ADD ITEM</h3>
            <button type="button" onclick="document.getElementById('dialog-packing').close()" class="p-2 bg-stone-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
         </div>
         <form onsubmit="window.app.savePacking(event)" class="space-y-3">
             <select id="pack-cat" class="w-full bg-stone-50 p-3 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900">
                <option value="Ë≠â‰ª∂Èå¢ÂåÖ">Ë≠â‰ª∂Èå¢ÂåÖ</option>
                <option value="Ë°£Áâ©Á©øÊê≠">Ë°£Áâ©Á©øÊê≠</option>
                <option value="ÈõªÂ≠êÁî¢ÂìÅ">ÈõªÂ≠êÁî¢ÂìÅ</option>
                <option value="Ëó•ÂìÅÈõúÁâ©">Ëó•ÂìÅÈõúÁâ©</option>
                <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
             </select>
             <input type="text" id="pack-name" placeholder="Áâ©ÂìÅÂêçÁ®±" class="w-full bg-stone-50 p-4 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900" required>
             <button type="submit" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg shadow-[4px_4px_0px_#10b981] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all border-2 border-stone-900 mt-2">ADD</button>
         </form>
    </div>
</dialog>

<!-- ÊÖæÊúõÊ∏ÖÂñÆÂΩàÁ™ó -->
<dialog id="dialog-wishlist">
    <div class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-2 border-stone-200">
         <div class="flex justify-between items-center mb-4">
            <h3 class="font-black text-xl text-stone-800">WISH ITEM</h3>
            <button type="button" onclick="document.getElementById('dialog-wishlist').close()" class="p-2 bg-stone-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
         </div>
         <form onsubmit="window.app.saveWishlist(event)" class="space-y-3">
             <input type="hidden" id="wish-id">
             <input type="text" id="wish-location" placeholder="Âú∞Èªû (‰æã: ÈÅìÈ†ìÂ¥õ)" class="w-full bg-stone-50 p-4 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900" required>
             <input type="text" id="wish-item" placeholder="È†ÖÁõÆ (‰æã: Á´†È≠öÁáí)" class="w-full bg-stone-50 p-4 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900" required>
             <div class="relative">
                <i data-lucide="map-pin" class="absolute left-3 top-3.5 w-4 h-4 text-stone-400"></i>
                <input type="text" id="wish-link" placeholder="Google Maps ÈÄ£Áµê Êàñ ÂÇôË®ª" class="w-full bg-stone-50 p-3 pl-10 rounded-xl text-sm outline-none border border-stone-200 focus:border-stone-900 font-bold">
            </div>
             <div class="flex gap-2">
                 <label class="flex-1 bg-stone-50 border-2 border-stone-200 rounded-xl p-3 flex items-center justify-center cursor-pointer has-[:checked]:border-stone-900 has-[:checked]:bg-stone-100">
                     <input type="radio" name="wish-type" value="eat" checked class="hidden">
                     <span class="font-bold text-sm"><i data-lucide="utensils" class="w-4 h-4 inline mr-1"></i> EAT</span>
                 </label>
                 <label class="flex-1 bg-stone-50 border-2 border-stone-200 rounded-xl p-3 flex items-center justify-center cursor-pointer has-[:checked]:border-stone-900 has-[:checked]:bg-stone-100">
                     <input type="radio" name="wish-type" value="buy" class="hidden">
                     <span class="font-bold text-sm"><i data-lucide="shopping-bag" class="w-4 h-4 inline mr-1"></i> BUY</span>
                 </label>
             </div>
             <button type="submit" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg shadow-[4px_4px_0px_#f97316] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all border-2 border-stone-900 mt-2">SAVE</button>
         </form>
    </div>
</dialog>

<!-- ÂøÖË≤∑Ê∏ÖÂñÆÂΩàÁ™ó -->
<dialog id="dialog-mustbuy">
    <div class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-2 border-stone-200">
         <div class="flex justify-between items-center mb-4">
            <h3 class="font-black text-xl text-stone-800">MUST BUY ITEM</h3>
            <button type="button" onclick="document.getElementById('dialog-mustbuy').close()" class="p-2 bg-stone-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
         </div>
         <form onsubmit="window.app.saveMustBuy(event)" class="space-y-3">
             <input type="hidden" id="mb-id">
             <input type="text" id="mb-name" placeholder="ÂïÜÂìÅÂêçÁ®±" class="w-full bg-stone-50 p-4 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900" required>
             <input type="text" id="mb-details" placeholder="ÂúñÁâáÈÄ£Áµê Êàñ ÊñáÂ≠óÂÇôË®ª" class="w-full bg-stone-50 p-4 rounded-xl text-sm outline-none border border-stone-200 focus:border-stone-900">
             <button type="submit" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg shadow-[4px_4px_0px_#f97316] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all border-2 border-stone-900 mt-2">SAVE</button>
         </form>
    </div>
</dialog>


<!-- Firebase & Logic -->
<script type="module">
    window.onerror = function(msg, url, line) {
        const toast = document.getElementById('error-toast');
        toast.style.display = 'block';
        toast.innerText = `ERROR: ${msg} (Line ${line})`;
        return false;
    };

    // [SECURE] Firebase Config injected via Environment Variable
    // Á≥ªÁµ±ÊúÉËá™ÂãïÊ≥®ÂÖ• __firebase_config ËÆäÊï∏Ôºå‰∏çÈúÄË¶ÅÂØ´Ê≠ªÂú®ÈÄôË£°
    const firebaseConfig = JSON.parse(__firebase_config);

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let fbApp, auth, db;
    try {
        fbApp = initializeApp(firebaseConfig);
        auth = getAuth(fbApp);
        db = getFirestore(fbApp);
    } catch (e) {
        console.error("Firebase init error", e);
        setTimeout(() => { document.getElementById('alert-msg').innerText = "Ë≥áÊñôÂ∫´ÈÄ£Á∑öÂ§±Êïó"; document.getElementById('dialog-alert').showModal(); }, 500);
    }
    
    const TRIP_ID = "tokyo_trip_shared";
    let userId = null;
    let activeDate = '2025-12-14';
    let cachedItinerary = [];
    let cachedWishlist = [];
    let cachedMustBuy = [];
    let memoList = []; 
    let calcVal = '0';
    let currentRate = 0.22;
    let calcMode = 'JPY_TWD';
    let sortableInstance = null;

    const petPhotos = [
        "1.jpg", "2.jpg", "3.jpg", "4.jpg", "5.jpg",
        "6.jpg", "7.jpg", "8.jpg", "9.jpg", "10.jpg"
    ];

    const uiApp = {
        init(user) {
            userId = user.uid;
            document.getElementById('auth-status-dot').classList.replace('bg-gray-300', 'bg-green-500');
            document.getElementById('auth-status-text').innerText = 'ONLINE';
            this.startListeners();
            this.updateRate();
            this.startSlideshow();
        },
        
        initOffline(guestId) {
            userId = guestId;
            document.getElementById('auth-status-text').innerText = 'OFFLINE';
            document.getElementById('auth-status-dot').classList.replace('bg-gray-300', 'bg-orange-400');
            this.startSlideshow();
            this.updateRate();
        },

        showCustomAlert(msg) {
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('dialog-alert').showModal();
        },

        switchView(view) {
            document.getElementById('view-home').classList.add('hidden-view');
            document.getElementById('view-home').classList.remove('active-view');
            
            ['itinerary', 'packing', 'wishlist', 'mustbuy'].forEach(v => {
                const el = document.getElementById('view-' + v);
                if (el) {
                    if(v === view) { el.classList.remove('hidden-view'); el.classList.add('active-view'); } 
                    else { el.classList.add('hidden-view'); el.classList.remove('active-view'); }
                }
            });

            const fab = document.getElementById('fab-calc');
            if(view === 'view-home') fab.style.display = 'none';
            else fab.style.display = 'flex';
            
            if(view === 'itinerary') this.renderItinerary();
            if(window.lucide) window.lucide.createIcons();
        },
        
        goHome() {
            document.querySelectorAll('.active-view').forEach(el => { el.classList.add('hidden-view'); el.classList.remove('active-view'); });
            document.getElementById('view-home').classList.remove('hidden-view');
            document.getElementById('view-home').classList.add('active-view');
            document.getElementById('fab-calc').style.display = 'none';
        },

        getCol(name) { return collection(db, `trips/${TRIP_ID}/${name}`); },

        startListeners() {
            if(!db) return;
            try {
                const qItin = query(this.getCol('itinerary'), orderBy('date'));
                onSnapshot(qItin, (snap) => {
                    cachedItinerary = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    cachedItinerary.sort((a, b) => {
                        const d = a.date.localeCompare(b.date);
                        if(d !== 0) return d;
                        
                        const tA = a.time || '';
                        const tB = b.time || '';
                        if (tA !== tB) return tA.localeCompare(tB);

                        if (a.order !== undefined && b.order !== undefined) return a.order - b.order;
                        return 0;
                    });
                    this.renderItinerary();
                });

                onSnapshot(query(this.getCol('memos'), orderBy('createdAt')), (snap) => {
                    memoList = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    this.renderMemo(memoList);
                });
                onSnapshot(query(this.getCol('packing')), (snap) => this.renderPacking(snap.docs.map(d=>({id:d.id, ...d.data()}))));
                
                onSnapshot(query(this.getCol('wishlist'), orderBy('createdAt')), (snap) => {
                    cachedWishlist = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    this.renderWishlist(cachedWishlist);
                });
                
                onSnapshot(query(this.getCol('mustbuy'), orderBy('createdAt')), (snap) => {
                    cachedMustBuy = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    this.renderMustBuy(cachedMustBuy);
                });
            } catch(e) { console.error("Listener init failed", e); }
        },

        renderItinerary() {
            const container = document.getElementById('list-itinerary');
            const tabs = document.getElementById('nav-dates');
            if(!container) return;
            
            if(sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }

            const fixedDates = ['2025-12-14','2025-12-15','2025-12-16','2025-12-17','2025-12-18','2025-12-19'];
            const grouped = cachedItinerary.reduce((acc, item) => { (acc[item.date] = acc[item.date] || []).push(item); return acc; }, {});
            const allDates = Array.from(new Set([...fixedDates, ...Object.keys(grouped).filter(d => d !== '0')]));
            allDates.sort();

            let tabsHtml = `<div onclick="window.app.switchDate('0')" class="date-tab ${activeDate==='0'?'active':''}"><span class="day-label">PRE</span><span class="date-num">‚òÖ</span></div>`;
            tabsHtml += allDates.map(d => {
                const dateObj = new Date(d);
                return `<div onclick="window.app.switchDate('${d}')" class="date-tab ${activeDate===d?'active':''}"><span class="day-label">DEC</span><span class="date-num">${dateObj.getDate()}</span></div>`;
            }).join('');
            tabs.innerHTML = tabsHtml;

            if(!activeDate) activeDate = '2025-12-14';
            const isPre = activeDate === '0';
            document.getElementById('section-memo').className = isPre ? 'block' : 'hidden';
            document.getElementById('section-itinerary').className = isPre ? 'hidden' : 'block';
            
            const btnContainer = document.getElementById('btn-itin-add-container');
            if(btnContainer) btnContainer.style.display = isPre ? 'none' : 'flex';

            if(!isPre) {
                const items = grouped[activeDate] || [];
                const dateObj = new Date(activeDate);
                this.fetchWeather(activeDate, (w, temp) => {
                    const el = document.getElementById('weather-info');
                    if(el) el.innerHTML = `${w} <span class="text-sm ml-1 font-bold">${temp}</span>`;
                });

                let html = `<div class="mb-6 flex items-center justify-between pl-1"><h3 class="font-black text-4xl text-stone-900 italic tracking-tighter uppercase">${dateObj.toLocaleDateString('en-US', {weekday:'long'})} <span class="text-stone-400 text-lg not-italic">${dateObj.getMonth()+1}/${dateObj.getDate()}</span></h3><div id="weather-info" class="text-2xl flex items-center">...</div></div>`;
                html += `<div id="timeline-sortable" class="timeline-container relative pb-10">`; 
                if(items.length === 0) html += `<div class="text-stone-400 text-center py-10 font-bold">NO PLANS YET</div>`;
                
                items.forEach(item => {
                    const handleHtml = `<div class="drag-handle absolute right-2 top-2 p-2 touch-none cursor-grab hover:bg-stone-100 rounded-full transition-colors"><i data-lucide="menu" class="w-5 h-5 text-stone-300"></i></div>`;
                    
                    // Á≠ÜË®ò (È†êË®≠Èö±Ëóè)
                    const hasNote = item.note && item.note.trim().length > 0;
                    const noteId = `note-${item.id}`;
                    // Â¶ÇÊûúÊúâÁ≠ÜË®òÔºåÂä†‰∏ä‰∏ÄÂÄãÂ∞èÂúñÁ§∫ÊèêÁ§∫
                    const noteIndicator = hasNote ? `<button onclick="event.stopPropagation(); document.getElementById('${noteId}').classList.toggle('hidden')" class="ml-2 text-orange-400 hover:text-orange-600 transition-colors p-1"><i data-lucide="sticky-note" class="w-4 h-4"></i></button>` : '';
                    const noteHtml = hasNote ? `<div id="${noteId}" class="hidden mt-3 text-sm text-stone-600 font-medium border-l-2 border-orange-200 pl-2 whitespace-pre-wrap animate-fade-in">${item.note}</div>` : '';

                    if(item.cat === 'Ëà™Áè≠') {
                         html += `
                         <div class="timeline-item group" data-id="${item.id}" onclick="window.app.openItineraryModal('${item.id}')">
                            <div class="timeline-line"></div>
                            <div class="bg-white border-2 border-stone-900 rounded-2xl p-4 relative shadow-[4px_4px_0px_#fcd34d] mb-6 ticket-card ml-8 active:scale-98 transition-transform cursor-pointer">
                                ${handleHtml}
                                <div class="flex justify-between items-center mb-4 border-b-2 border-dashed border-stone-300 pb-2">
                                    <div class="font-mono font-bold text-stone-500 text-xs flex items-center">FLIGHT TICKET ${noteIndicator}</div>
                                    <div class="font-mono font-black text-stone-300 text-xs tracking-widest uppercase pr-2">BOARDING PASS</div>
                                </div>
                                <div class="flex justify-between items-center mb-2">
                                    <div class="text-center">
                                        <div class="text-4xl font-black text-stone-900">TPE</div>
                                        <div class="text-xs font-bold text-stone-400 mt-1">DEP ${item.time || '--:--'}</div>
                                    </div>
                                    <div class="flex-grow px-4 text-center relative">
                                        <div class="border-t-2 border-stone-300 absolute top-1/2 left-4 right-4 -translate-y-1/2"></div>
                                        <i data-lucide="plane" class="text-stone-900 w-6 h-6 relative z-10 bg-white px-1 mx-auto rotate-90"></i>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-4xl font-black text-stone-900">TYO</div>
                                        <div class="text-xs font-bold text-stone-400 mt-1">ARR ${item.endTime || '--:--'}</div>
                                    </div>
                                </div>
                                <div class="text-center mt-4 pt-2 border-t-2 border-dashed border-stone-100 font-bold text-stone-600 bg-stone-50 rounded-lg py-2">
                                    ${item.title || 'FLIGHT'}
                                </div>
                                ${noteHtml}
                            </div>
                         </div>`;
                    } else if(item.cat === '‰∫§ÈÄö') {
                        html += `<div class="timeline-item" data-id="${item.id}" onclick="window.app.openItineraryModal('${item.id}')">
                            <div class="timeline-line"></div>
                            <div class="flex items-center gap-3 mb-4 timeline-content-wrapper">
                                <div class="w-12 h-12 bg-stone-900 rounded-full flex items-center justify-center text-white z-10 border-2 border-white flex-shrink-0 shadow-md"><i data-lucide="bus" class="w-6 h-6"></i></div>
                                <div class="bg-stone-200 px-3 py-2 rounded-lg text-xs font-bold text-stone-600 flex-grow relative pr-10 group active:scale-98 transition-transform cursor-pointer">
                                    ${item.time} ${item.title} <span class="opacity-50 flex items-center inline-block align-middle">${noteIndicator}</span>
                                    <div class="drag-handle absolute right-1 top-1/2 -translate-y-1/2 p-2 touch-none cursor-grab"><i data-lucide="menu" class="w-4 h-4 text-stone-400"></i></div>
                                    ${noteHtml}
                                </div>
                            </div></div>`;
                    } else {
                        const isHotel = item.cat === '‰ΩèÂÆø';
                        const dotStyle = isHotel ? 'background:#f97316; border-color:#1c1917;' : '';
                        
                        const mapUrl = item.map ? item.map : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}`;
                        const mapBtn = `<div class="flex gap-2 mt-3"><a href="${mapUrl}" target="_blank" onclick="event.stopPropagation()" class="w-full bg-stone-100 hover:bg-stone-900 hover:text-white text-stone-600 py-3 rounded-lg text-xs font-black border border-stone-200 transition-colors flex items-center justify-center tracking-wider shadow-sm gap-2"><i data-lucide="map" class="w-3 h-3"></i> MAP ‚Üó</a></div>`;

                        html += `<div class="timeline-item group cursor-pointer" data-id="${item.id}" onclick="window.app.openItineraryModal('${item.id}')">
                            <div class="timeline-line"></div>
                            <div class="timeline-dot" style="${dotStyle}"></div>
                            <div class="flex gap-4 mb-6 timeline-content-wrapper">
                                <div class="w-12 text-right pt-1 font-mono font-bold text-stone-600 text-sm flex-shrink-0">${item.time || ''}</div>
                                <div class="flex-grow card-marble p-4 relative active:scale-98 transition-transform">
                                    ${handleHtml}
                                    <div class="flex justify-between items-start mb-1"><h3 class="font-black text-xl uppercase leading-tight pr-8">${item.title}</h3></div>
                                    <div class="text-xs font-bold text-stone-400 mb-1 flex items-center">#${item.cat} ${noteIndicator}</div>
                                    ${noteHtml}
                                    ${mapBtn}
                                </div>
                            </div>
                        </div>`;
                    }
                });
                html += `</div>`;
                container.innerHTML = html;

                const sortEl = document.getElementById('timeline-sortable');
                if(sortEl) {
                    sortableInstance = new Sortable(sortEl, {
                        handle: '.drag-handle',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        delay: 0,
                        delayOnTouchOnly: false,
                        onEnd: function(evt) {
                            window.app.updateItineraryOrder();
                        }
                    });
                }
            }
            if(window.lucide) window.lucide.createIcons();
        },
        switchDate(d) { activeDate = d; this.renderItinerary(); },
        async fetchWeather(dateStr, cb) { try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&daily=weathercode,temperature_2m_max&timezone=Asia%2FTokyo&start_date=${dateStr}&end_date=${dateStr}`); const data = await res.json(); const code = data.daily.weathercode[0]; const temp = data.daily.temperature_2m_max[0]; let icon = '‚òÅÔ∏è'; if (code <= 1) icon = '‚òÄÔ∏è'; else if (code <= 3) icon = '‚õÖ'; else if (code <= 67) icon = 'üåßÔ∏è'; else if (code <= 77) icon = '‚ùÑÔ∏è'; cb(icon, `${Math.round(temp)}¬∞C`); } catch(e) { cb('‚ú®', ''); } },
        
        renderMemo(items) {
            const list = document.getElementById('list-memo');
            list.innerHTML = items.map(item => `
                <div class="card-marble bg-white p-5 mb-4 relative">
                    <div class="flex justify-between items-start mb-2 border-b-2 border-stone-100 pb-2">
                        <h3 class="font-black text-xl text-stone-900 uppercase">${item.title}</h3>
                        <div class="flex gap-2">
                            <button onclick="window.app.openMemoModal('${item.id}')" class="text-stone-300 hover:text-stone-900"><i data-lucide="edit-2" class="w-5 h-5"></i></button>
                            <button onclick="event.stopPropagation(); window.app.delDoc('memos', '${item.id}')" class="text-stone-300 hover:text-red-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div class="memo-content">${item.content}</div>
                </div>
            `).join('');
            if(window.lucide) window.lucide.createIcons();
        },

        renderPacking(items) {
            const container = document.getElementById('packing-container');
            const cats = ["Ë≠â‰ª∂Èå¢ÂåÖ", "Ë°£Áâ©Á©øÊê≠", "ÈõªÂ≠êÁî¢ÂìÅ", "Ëó•ÂìÅÈõúÁâ©", "ÂÖ∂‰ªñ"];
            container.innerHTML = cats.map(cat => {
                const filtered = items.filter(i => i.category === cat);
                if(filtered.length === 0) return '';
                return `<div class="card-marble p-4 bg-white"><div class="flex justify-between border-b-2 border-stone-100 pb-2 mb-2"><span class="font-black text-sm uppercase text-stone-800">${cat}</span><span class="text-xs font-bold text-stone-500 bg-stone-100 px-2 py-0.5 rounded-full">${filtered.filter(x=>x.checked).length}/${filtered.length}</span></div><div class="space-y-2">${filtered.map(i => `<div class="flex items-center"><input type="checkbox" class="checkbox-industrial mr-3 scale-75" ${i.checked?'checked':''} onchange="window.app.togglePack('${i.id}', this.checked)"><span class="flex-grow text-sm font-bold ${i.checked?'line-through text-stone-300':'text-stone-800'}">${i.name}</span><button type="button" class="p-3 text-stone-300 hover:text-red-500 active:text-red-700" onclick="event.stopPropagation(); window.app.delDoc('packing', '${i.id}')"><i data-lucide="x" class="w-4 h-4"></i></button></div>`).join('')}</div></div>`;
            }).join('');
            if(window.lucide) window.lucide.createIcons();
        },

        renderWishlist(items) {
            const list = document.getElementById('list-wishlist');
            const grouped = items.reduce((acc, item) => { (acc[item.location] = acc[item.location] || []).push(item); return acc; }, {});
            
            if(Object.keys(grouped).length === 0) { list.innerHTML = `<div class="text-center text-stone-400 font-bold py-10">NO WISHES YET</div>`; return; }

            list.innerHTML = Object.keys(grouped).map(loc => `
                <div class="card-marble bg-white p-4">
                    <h3 class="font-black text-lg text-stone-900 border-b-2 border-stone-100 pb-2 mb-3 flex items-center">
                        <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i> ${loc}
                    </h3>
                    <div class="space-y-3">
                        ${grouped[loc].map(i => {
                            let mapLink = '';
                            if(i.link && i.link.trim() !== '') {
                                const url = i.link.startsWith('http') ? i.link : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.location + ' ' + i.name)}`;
                                mapLink = `<a href="${url}" target="_blank" onclick="event.stopPropagation()" class="text-[10px] font-black bg-stone-100 hover:bg-stone-900 hover:text-white text-stone-600 px-2 py-1 rounded ml-2 border border-stone-200 transition-colors">GO ‚Üó</a>`;
                            } else {
                                const searchUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.location + ' ' + i.name)}`;
                                mapLink = `<a href="${searchUrl}" target="_blank" onclick="event.stopPropagation()" class="text-[10px] font-black bg-stone-100 hover:bg-stone-900 hover:text-white text-stone-600 px-2 py-1 rounded ml-2 border border-stone-200 transition-colors">GO ‚Üó</a>`;
                            }

                            return `
                            <div class="flex justify-between items-center bg-stone-50 p-3 rounded-xl border border-stone-100 cursor-pointer hover:bg-stone-100 transition-colors group" onclick="window.app.openWishlistModal('${i.id}')">
                                <div class="flex items-center gap-3 overflow-hidden">
                                    <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${i.type==='eat'?'bg-orange-100 text-orange-600':'bg-stone-200 text-stone-600'}">
                                        <i data-lucide="${i.type==='eat'?'utensils':'shopping-bag'}" class="w-4 h-4"></i>
                                    </div>
                                    <div class="flex flex-col overflow-hidden">
                                        <div class="flex items-center">
                                            <span class="font-bold text-stone-800 truncate">${i.name}</span>
                                            ${mapLink}
                                        </div>
                                        ${(i.link && !i.link.startsWith('http')) ? `<div class="text-xs text-stone-400 font-bold truncate">${i.link}</div>` : ''}
                                    </div>
                                </div>
                                <div class="flex-shrink-0 flex items-center">
                                    <i data-lucide="pencil" class="w-4 h-4 text-stone-300 mr-3 group-hover:text-stone-500"></i>
                                    <button onclick="event.stopPropagation(); window.app.delDoc('wishlist', '${i.id}')" class="text-stone-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
            if(window.lucide) window.lucide.createIcons();
        },

        renderMustBuy(items) {
            const list = document.getElementById('list-mustbuy');
            items.sort((a, b) => (a.checked === b.checked) ? 0 : a.checked ? 1 : -1);
            
            if(items.length === 0) { list.innerHTML = `<div class="text-center text-stone-400 font-bold py-10">NO ITEMS YET</div>`; return; }

            list.innerHTML = items.map(i => {
                const hasDetails = i.details && i.details.trim() !== '';
                let detailContent = '';
                if(hasDetails) {
                    const isUrl = i.details.startsWith('http');
                    if(isUrl) {
                        detailContent = `<div class="mt-3 rounded-lg overflow-hidden border-2 border-stone-900"><img src="${i.details}" class="w-full h-40 object-cover" onerror="this.style.display='none'"></div>`;
                    } else {
                        detailContent = `<div class="mt-3 p-3 bg-orange-50 text-orange-800 font-bold text-sm rounded-lg border-l-4 border-orange-400">${i.details}</div>`;
                    }
                }

                return `
                <div class="card-marble-sm bg-white p-3 flex flex-col transition-all ${i.checked ? 'item-checked bg-stone-100' : ''}">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" class="checkbox-custom" ${i.checked?'checked':''} onchange="window.app.toggleMustBuy('${i.id}', this.checked)">
                        <div class="flex-grow font-black text-lg text-stone-800 cursor-pointer hover:text-orange-600 transition-colors" onclick="document.getElementById('mb-detail-${i.id}') && document.getElementById('mb-detail-${i.id}').classList.toggle('hidden')">
                            ${i.name} ${hasDetails ? '<i data-lucide="sticky-note" class="w-3 h-3 inline text-stone-400 ml-1 align-top"></i>' : ''}
                        </div>
                        <div class="flex items-center">
                             <button onclick="event.stopPropagation(); window.app.openMustBuyModal('${i.id}')" class="text-stone-300 hover:text-stone-900 p-2"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                             <button onclick="window.app.delDoc('mustbuy', '${i.id}')" class="text-stone-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    ${hasDetails ? `<div id="mb-detail-${i.id}" class="hidden ml-9 transition-all">${detailContent}</div>` : ''}
                </div>
            `}).join('');
            if(window.lucide) window.lucide.createIcons();
        },

        startSlideshow() { let i = 0; const el = document.getElementById('pet-frame'); setInterval(() => { el.style.backgroundImage = `url(${petPhotos[i]})`; i = (i + 1) % petPhotos.length; }, 3000); el.style.backgroundImage = `url(${petPhotos[0]})`; },
        
        openItineraryModal(id=null) {
            const form = document.getElementById('form-itinerary');
            form.reset();
            document.getElementById('itin-id').value = '';
            document.getElementById('btn-del-itin').classList.add('hidden');
            if(activeDate && activeDate !== '0') document.getElementById('itin-date').value = activeDate;
            if(id) {
                const item = cachedItinerary.find(i => i.id === id);
                if(item) {
                    document.getElementById('itin-id').value = item.id;
                    document.getElementById('itin-date').value = item.date;
                    document.getElementById('itin-time').value = item.time;
                    document.getElementById('itin-end-time').value = item.endTime || '';
                    document.getElementById('itin-cat').value = item.cat;
                    document.getElementById('itin-title').value = item.title;
                    document.getElementById('itin-note').value = item.note;
                    document.getElementById('itin-map').value = item.map;
                    document.getElementById('btn-del-itin').classList.remove('hidden');
                }
            }
            document.getElementById('dialog-itinerary').showModal();
        },
        openMemoModal(id=null) {
            const form = document.getElementById('form-memo');
            form.reset();
            document.getElementById('memo-id').value = '';
            if(id) {
                const item = memoList.find(i => i.id === id);
                if(item) {
                    document.getElementById('memo-id').value = item.id;
                    document.getElementById('memo-title').value = item.title;
                    document.getElementById('memo-content').value = item.content;
                }
            }
            document.getElementById('dialog-memo').showModal();
        },
        openWishlistModal(id=null) {
            const form = document.querySelector('#dialog-wishlist form');
            form.reset();
            document.getElementById('wish-id').value = '';
            if(id) {
                const item = cachedWishlist.find(i => i.id === id);
                if(item) {
                    document.getElementById('wish-id').value = item.id;
                    document.getElementById('wish-location').value = item.location;
                    document.getElementById('wish-item').value = item.name;
                    document.getElementById('wish-link').value = item.link || '';
                    const radio = form.querySelector(`input[name="wish-type"][value="${item.type}"]`);
                    if(radio) radio.checked = true;
                }
            }
            document.getElementById('dialog-wishlist').showModal();
        },
        openMustBuyModal(id=null) {
            const form = document.querySelector('#dialog-mustbuy form');
            form.reset();
            document.getElementById('mb-id').value = '';
            if(id) {
                const item = cachedMustBuy.find(i => i.id === id);
                if(item) {
                    document.getElementById('mb-id').value = item.id;
                    document.getElementById('mb-name').value = item.name;
                    document.getElementById('mb-details').value = item.details || '';
                }
            }
            document.getElementById('dialog-mustbuy').showModal();
        },
        openCalculator() { document.getElementById('dialog-calculator').showModal(); },
        
        async saveMemo() { 
            const id = document.getElementById('memo-id').value;
            const title = document.getElementById('memo-title').value;
            const content = document.getElementById('memo-content').value;
            if(!title) return;
            try { 
                if(id) {
                    await updateDoc(doc(db, `trips/${TRIP_ID}/memos`, id), { title, content });
                } else {
                    await addDoc(this.getCol('memos'), { title, content, createdAt: serverTimestamp() }); 
                }
                document.getElementById('dialog-memo').close();
            } catch(e) { console.error(e); uiApp.showCustomAlert("ÂÑ≤Â≠òÂ§±Êïó: " + e.message); } 
        },
        async togglePack(id, state) { try { await updateDoc(doc(db, `trips/${TRIP_ID}/packing`, id), {checked: state}); } catch(e) { console.error(e); } },
        async toggleMustBuy(id, state) { try { await updateDoc(doc(db, `trips/${TRIP_ID}/mustbuy`, id), {checked: state}); } catch(e) { console.error(e); } },
        
        // Áõ¥Êé•Âà™Èô§Ôºå‰∏çÁ¢∫Ë™ç
        async delDoc(col, id) { 
            try { await deleteDoc(doc(db, `trips/${TRIP_ID}/${col}`, id)); } 
            catch(e) { console.error(e); uiApp.showCustomAlert("Âà™Èô§Â§±Êïó"); } 
        },
        async deleteItinerary() { 
            const id = document.getElementById('itin-id').value; 
            try { 
                await deleteDoc(doc(db, `trips/${TRIP_ID}/itinerary`, id)); 
                document.getElementById('dialog-itinerary').close(); 
            } catch(e) { console.error(e); uiApp.showCustomAlert("Âà™Èô§Â§±Êïó"); } 
        },
        
        async updateItineraryOrder() {
            const list = document.getElementById('timeline-sortable');
            const items = list.querySelectorAll('.timeline-item');
            const batch = writeBatch(db);
            
            items.forEach((el, index) => {
                const id = el.getAttribute('data-id');
                const ref = doc(db, `trips/${TRIP_ID}/itinerary`, id);
                batch.update(ref, { order: index });
            });
            try { await batch.commit(); } catch(e) { console.error('Order update failed', e); }
        },

        toggleCurrency() {
            calcMode = calcMode === 'JPY_TWD' ? 'TWD_JPY' : 'JPY_TWD';
            document.getElementById('calc-mode-text').innerText = calcMode === 'JPY_TWD' ? 'JPY ‚Üí TWD' : 'TWD ‚Üí JPY';
            document.getElementById('calc-input-unit').innerText = calcMode === 'JPY_TWD' ? 'JPY' : 'TWD';
            document.getElementById('calc-output-unit').innerText = calcMode === 'JPY_TWD' ? 'TWD' : 'JPY';
            this.updateCalc();
        },
        calcAppend(n) { if(calcVal==='0'&&n!=='.')calcVal=''; if(n==='.'&&calcVal.includes('.'))return; calcVal+=n; this.updateCalc(); },
        calcDel() { calcVal=calcVal.slice(0,-1)||'0'; this.updateCalc(); },
        calcClear() { calcVal='0'; this.updateCalc(); },
        updateCalc() { 
            document.getElementById('calc-display').value = Number(calcVal).toLocaleString(); 
            const val = parseFloat(calcVal||0);
            let res = 0;
            if (calcMode === 'JPY_TWD') res = Math.round(val * currentRate);
            else res = Math.round(val / currentRate);
            document.getElementById('calc-res').innerText = res.toLocaleString(); 
        },
        
        async saveItinerary(e) {
            e.preventDefault();
            const id = document.getElementById('itin-id').value;
            const endTime = document.getElementById('itin-end-time').value;
            const data = { 
                date: document.getElementById('itin-date').value, 
                time: document.getElementById('itin-time').value, 
                endTime: endTime,
                cat: document.getElementById('itin-cat').value, 
                title: document.getElementById('itin-title').value, 
                note: document.getElementById('itin-note').value, 
                map: document.getElementById('itin-map').value 
            };
            try {
                if(id) {
                    await updateDoc(doc(db, `trips/${TRIP_ID}/itinerary`, id), data);
                } else { 
                    const currentItems = cachedItinerary.filter(i => i.date === data.date);
                    data.order = currentItems.length;
                    data.createdAt = serverTimestamp(); 
                    await addDoc(uiApp.getCol('itinerary'), data); 
                }
                document.getElementById('dialog-itinerary').close();
                activeDate = data.date;
            } catch(e) { console.error(e); uiApp.showCustomAlert("ÂÑ≤Â≠òÂ§±Êïó"); }
        },
        async savePacking(e) { 
            e.preventDefault(); 
            try { 
                await addDoc(uiApp.getCol('packing'), { name: document.getElementById('pack-name').value, category: document.getElementById('pack-cat').value, checked: false, createdAt: serverTimestamp() }); 
                document.getElementById('pack-name').value=''; 
                document.getElementById('dialog-packing').close(); 
            } catch(e) { console.error(e); uiApp.showCustomAlert("Êñ∞Â¢ûÂ§±Êïó"); } 
        },
        async saveWishlist(e) {
            e.preventDefault();
            const id = document.getElementById('wish-id').value;
            const type = document.querySelector('input[name="wish-type"]:checked').value;
            const data = { 
                location: document.getElementById('wish-location').value,
                name: document.getElementById('wish-item').value,
                link: document.getElementById('wish-link').value,
                type: type
            };
            try {
                if(id) {
                    await updateDoc(doc(db, `trips/${TRIP_ID}/wishlist`, id), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(uiApp.getCol('wishlist'), data);
                }
                e.target.reset();
                document.getElementById('dialog-wishlist').close();
            } catch(e) { console.error(e); uiApp.showCustomAlert("ÂÑ≤Â≠òÂ§±Êïó"); }
        },
        async saveMustBuy(e) { 
            e.preventDefault(); 
            const id = document.getElementById('mb-id').value;
            const data = { 
                name: document.getElementById('mb-name').value, 
                details: document.getElementById('mb-details').value
            };
            try { 
                if(id) {
                    await updateDoc(doc(db, `trips/${TRIP_ID}/mustbuy`, id), data);
                } else {
                    data.checked = false;
                    data.createdAt = serverTimestamp();
                    await addDoc(uiApp.getCol('mustbuy'), data); 
                }
                e.target.reset(); 
                document.getElementById('dialog-mustbuy').close(); 
            } catch(e) { console.error(e); uiApp.showCustomAlert("ÂÑ≤Â≠òÂ§±Êïó"); } 
        },
        async updateRate() { 
            try { 
                const res=await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); 
                const d=await res.json(); 
                currentRate=d.rates.TWD; 
                this.updateCalc(); 
            } catch(e){} 
        }
    };
    
    window.app = uiApp;

    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('dialog-calculator').addEventListener('close', () => { 
            const view = document.querySelector('.active-view').id; 
            if(view !== 'view-home') document.getElementById('fab-calc').style.display = 'flex'; 
        });
        
        // [SECURE] Enhanced Auth Logic with fallback
        const initAuth = async () => {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        };
        initAuth().catch(console.error);

        onAuthStateChanged(auth, (user) => {
            if (user) { uiApp.init(user); } 
            else { 
                // Fallback handled by initAuth, but good to have listener
            }
        });
    });
</script>
</body>
</html>