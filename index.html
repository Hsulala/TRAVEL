<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TRIP PLANNER</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#e5e5e5">

    <link rel="apple-touch-icon" href="logo.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');

        body { 
            font-family: 'Barlow', 'Noto Sans TC', sans-serif;
            background-color: #e5e5e5; 
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            color: #1c1917;
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; position: relative; background-color: transparent; padding-bottom: 80px; }
        ::-webkit-scrollbar { display: none; }

        .home-safe-padding { padding-top: calc(env(safe-area-inset-top) + 20px); }

        .sticky-header-safe {
            position: sticky; top: 0; z-index: 40; background-color: #e5e5e5;
            padding-top: calc(env(safe-area-inset-top) + 10px);
            padding-bottom: 10px; padding-left: 1rem; padding-right: 1rem;
            margin-left: -1rem; margin-right: -1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
        }

        .card-marble { background-color: #ffffff; border: 3px solid #1c1917; border-radius: 20px; box-shadow: 6px 6px 0px #1c1917; transition: transform 0.1s, box-shadow 0.1s; }
        .card-marble:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #1c1917; }
        
        .card-marble-sm { background-color: #ffffff; border: 2px solid #1c1917; border-radius: 12px; box-shadow: 3px 3px 0px #1c1917; }
        
        .menu-icon { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; padding: 1.2rem; height: 130px; position: relative; overflow: hidden; }
        .menu-icon i { width: 28px; height: 28px; margin-bottom: 8px; color: #1c1917; stroke-width: 2.5px; }
        .menu-icon span { font-weight: 900; text-transform: uppercase; font-size: 1.1rem; letter-spacing: 0.5px; line-height: 1; }
        .menu-icon .subtitle { font-size: 0.7rem; font-weight: 700; color: #78716c; margin-top: 4px; }

        .hidden-view { display: none; }
        .active-view { display: block; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

        .timeline-item { position: relative; }
        .timeline-line { position: absolute; left: 19px; top: 24px; bottom: -10px; width: 3px; background: #d6d3d1; z-index: 0; }
        .timeline-dot { position: absolute; left: 11px; top: 24px; width: 19px; height: 19px; background: #1c1917; border: 3px solid #f97316; border-radius: 50%; z-index: 10; }
        .timeline-content-wrapper { padding-left: 50px; position: relative; }
        
        .sortable-ghost { opacity: 0.2; background: #e7e5e4; border: 2px dashed #1c1917; }
        .sortable-drag { opacity: 0.9; transform: scale(1.02); z-index: 50; background: white; }
        .drag-handle { touch-action: none; cursor: grab; padding: 8px; color: #d6d3d1; }
        .drag-handle:active { cursor: grabbing; color: #f97316; }
        
        .memo-content { white-space: pre-wrap; word-break: break-word; font-size: 0.9rem; line-height: 1.5; color: #44403c; }

        .fab-calc { position: fixed; bottom: 40px; right: 20px; width: 64px; height: 64px; border-radius: 50%; background: #f97316; border: 3px solid #1c1917; color: white; display: none; align-items: center; justify-content: center; box-shadow: 4px 4px 0px #1c1917; z-index: 50; transition: transform 0.1s; }
        .fab-calc:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #1c1917; }

        .big-action-btn { pointer-events: auto; cursor: pointer; width: 100%; padding: 16px; border-radius: 50px; font-weight: 900; font-size: 18px; border: 3px solid #1c1917; display: flex; justify-content: center; align-items: center; gap: 8px; box-shadow: 4px 4px 0px rgba(0,0,0,0.1); transition: transform 0.1s; background: #1c1917; color: white; }
        .big-action-btn:active { transform: scale(0.98); box-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        .btn-orange { background: #f97316; border-color: #c2410c; color: white; }

        .header-bar { display: flex; justify-content: space-between; align-items: center; } 
        .back-btn { width: 40px; height: 40px; border: 2px solid #1c1917; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 2px 2px 0px #1c1917; }
        
        .date-tab { flex-shrink: 0; width: 60px; height: 64px; border: 2px solid #1c1917; background: white; color: #1c1917; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; cursor: pointer; transition: all 0.2s; box-shadow: 3px 3px 0px #a8a29e; border-radius: 12px; }
        .date-tab.active { background: #1c1917; color: #f97316; box-shadow: 3px 3px 0px #f97316; transform: translate(-1px, -1px); }
        
        .checkbox-custom { appearance: none; width: 24px; height: 24px; border: 2px solid #1c1917; background: white; display: grid; place-content: center; cursor: pointer; flex-shrink: 0; border-radius: 6px; }
        .checkbox-custom::before { content: ""; width: 14px; height: 14px; transform: scale(0); transition: 0.1s transform ease-in-out; background: #1c1917; border-radius: 2px; }
        .checkbox-custom:checked::before { transform: scale(1); }
        .checkbox-custom:checked { background: #e5e5e5; border-color: #78716c; }
        .checkbox-custom:checked::before { background: #78716c; }

        .item-checked { opacity: 0.5; order: 999; }
        .item-checked span { text-decoration: line-through; }

        dialog { border-radius: 24px; border: none; padding: 0; background: transparent; width: 90%; max-width: 400px; z-index: 100; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(3px); z-index: 99; }
        
        .pet-frame { position: relative; overflow: hidden; background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out; }
        .pet-frame::after { content: ""; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); }
        
        .expanded-image { width: 100%; border-radius: 12px; margin-top: 12px; border: 2px solid #1c1917; display: block; object-fit: cover; }
        .file-upload-label { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; border: 2px dashed #1c1917; border-radius: 12px; color: #57534e; font-weight: bold; cursor: pointer; background: #fafaf9; transition: all 0.2s; }
        .file-upload-label:active { background: #e7e5e4; border-style: solid; }

        /* [å›å¾©] è¨ˆç®—æ©Ÿæ¨£å¼ - å›æ­¸ç±³è‰²å¤§ç†çŸ³é¢¨æ ¼ï¼Œä½†ä¿ç•™æ–°å¸ƒå±€ */
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .calc-btn { 
            height: 60px; 
            border-radius: 12px; /* è®Šå›åœ“è§’çŸ©å½¢ */
            background: white; 
            color: #1c1917; 
            font-size: 20px; 
            font-weight: 900; 
            border: 2px solid #1c1917; /* åŠ å›é»‘è‰²é‚Šæ¡† */
            box-shadow: 2px 2px 0 #1c1917; /* åŠ å›é™°å½± */
            display: flex; align-items: center; justify-content: center; 
            transition: all 0.1s; 
            cursor: pointer;
        }
        .calc-btn:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0 #1c1917; }
        
        /* æ¨£å¼èª¿æ•´ */
        .calc-btn-num { background: white; }
        .calc-btn-op { background: #fef3c7; color: #d97706; } /* æ·ºé»ƒè‰²èƒŒæ™¯ */
        .calc-btn-func { background: #f5f5f4; color: #78716c; } /* æ·ºç°è‰²èƒŒæ™¯ */
        .calc-btn-zero { grid-column: span 2; }
        .calc-btn-eq { background: #1c1917; color: white; border-color: #1c1917; box-shadow: 2px 2px 0 #ea580c; } /* æ·±è‰²ç­‰æ–¼éµ */

        #calc-display { font-family: 'Barlow', sans-serif; font-weight: 900; letter-spacing: -1px; }
    </style>
</head>
<body>

<div id="error-toast" style="display:none; position:fixed; top:0; left:0; right:0; background:red; color:white; padding:10px; z-index:9999; font-size:12px; font-weight:bold; text-align:center;"></div>

<div class="app-container p-4">
    
    <!-- 0. é¦–é  -->
    <div id="view-home" class="active-view home-safe-padding">
        <header class="mb-6 flex justify-between items-start">
            <div onclick="window.app.openTripIdModal()" class="cursor-pointer">
                <div class="text-xs font-black tracking-[0.2em] text-orange-600 mb-1">TRIP PLANNER</div>
                <h1 class="text-3xl font-black text-stone-900 tracking-tighter italic uppercase break-all" id="home-title">TOKYO<span class="text-orange-500">.</span></h1>
                <div class="flex items-center mt-2 text-xs font-bold text-stone-500">
                    <div id="auth-status-dot" class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    <span id="auth-status-text">ONLINE</span>
                </div>
            </div>
            <button onclick="window.app && window.app.openCalculator()" style="width:56px; height:56px; background:#f97316; color:white; border:2px solid #1c1917; border-radius:16px; box-shadow:3px 3px 0 #1c1917; display:flex; align-items:center; justify-content:center;" class="active:translate-y-1 active:shadow-none transition-all">
                <i data-lucide="calculator" class="w-7 h-7"></i>
            </button>
        </header>

        <div class="grid grid-cols-2 gap-4 pb-20">
            <!-- è¡Œç¨‹ (ä¸Šæ–¹å¤§æ ¼) -->
            <button onclick="window.app && window.app.switchView('itinerary')" class="card-marble col-span-2 flex flex-row gap-4 items-center p-6 h-40 bg-stone-50 hover:bg-stone-100 relative overflow-hidden active:scale-95 transition-transform">
                <div class="bg-stone-900 text-white p-4 rounded-full border-2 border-stone-900 z-10 w-16 h-16 flex items-center justify-center mb-4">
                    <i data-lucide="map" class="w-8 h-8 !text-white !m-0"></i>
                </div>
                <div class="flex-grow text-left z-10">
                    <span class="block text-4xl font-black tracking-tighter text-stone-900">ITINERARY</span>
                </div>
                <i data-lucide="arrow-right" class="w-8 h-8 z-10 text-stone-900 absolute bottom-6 right-6"></i>
                <div class="absolute -right-10 -top-10 w-48 h-48 bg-orange-500 rounded-full opacity-10 z-0"></div>
            </button>

            <!-- å››å¤§åŠŸèƒ½æ ¼ -->
            <button onclick="window.app && window.app.switchView('wishlist')" class="card-marble menu-icon hover:bg-stone-100 bg-white active:bg-stone-200">
                <i data-lucide="heart"></i>
                <span class="text-stone-900">WISHLIST</span>
                <div class="subtitle">æ…¾æœ›æ¸…å–®</div>
            </button>

            <button onclick="window.app && window.app.switchView('packing')" class="card-marble menu-icon hover:bg-stone-100 bg-white active:bg-stone-200">
                <i data-lucide="luggage"></i>
                <span class="text-stone-900">PACKING</span>
                <div class="subtitle">è¡Œææ¸…å–®</div>
            </button>

            <button onclick="window.app && window.app.switchView('mustbuy')" class="card-marble menu-icon hover:bg-stone-100 bg-white active:bg-stone-200">
                <i data-lucide="shopping-bag"></i>
                <span class="text-stone-900">MUST BUY</span>
                <div class="subtitle">å¿…è²·æ¸…å–®</div>
            </button>

            <!-- è¨­å®š/åˆ‡æ›æ—…ç¨‹ -->
            <button onclick="window.app.openTripIdModal()" class="card-marble menu-icon hover:bg-stone-100 bg-white active:bg-stone-200">
                <i data-lucide="settings"></i>
                <span class="text-stone-900">SETTINGS</span>
                <div class="subtitle">åˆ‡æ›æ—…ç¨‹</div>
            </button>

            <!-- å·¥å…·ç®± (ç§»åˆ°é€™è£¡) -->
            <button onclick="window.app.openTools()" class="card-marble menu-icon hover:bg-stone-100 bg-white active:bg-stone-200">
                <i data-lucide="wrench"></i>
                <span class="text-stone-900">TOOLS</span>
                <div class="subtitle">å¯¦ç”¨é€£çµ</div>
            </button>
            
            <!-- My Pets (ç§»åˆ°æœ€å¾Œä¸€æ ¼) -->
            <div id="pet-frame" class="card-marble menu-icon pet-frame p-0 border-dashed border-stone-400 bg-stone-200">
                <div class="absolute bottom-3 left-3 text-white font-bold text-xs z-10 flex items-center drop-shadow-md">
                    <i data-lucide="heart" class="w-3 h-3 mr-1 fill-orange-500 text-orange-500"></i> My Pets
                </div>
            </div>
        </div>
    </div>

    <!-- 1. è¡Œç¨‹ -->
    <div id="view-itinerary" class="hidden-view">
        <div class="sticky-header-safe header-bar">
            <button onclick="window.app.goHome()" class="back-btn"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h2 class="font-black text-2xl tracking-tight text-stone-900">ITINERARY</h2>
            <div class="flex gap-2 bg-white/80 backdrop-blur p-1.5 rounded-2xl border-2 border-stone-200">
                <button onclick="window.app.switchView('wishlist')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="heart" class="w-5 h-5"></i></button>
                <button onclick="window.app.switchView('mustbuy')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="shopping-bag" class="w-5 h-5"></i></button>
            </div>
        </div>
        <div id="date-weather-header" class="mb-4 pl-1 hidden">
             <h3 class="font-black text-4xl text-stone-900 italic tracking-tighter uppercase inline-block mr-2" id="header-date"></h3>
             <div id="header-weather" class="inline-flex items-center text-stone-500"></div>
        </div>

        <div id="nav-dates" class="flex overflow-x-auto gap-3 pb-4 mb-2"></div>
        
        <div id="section-memo" class="hidden">
             <div id="list-memo" class="space-y-4"></div>
             <div class="flow-btn-container">
                 <button onclick="window.app.openMemoModal()" class="big-action-btn"><i data-lucide="sticky-note" class="w-5 h-5"></i> æ–°å¢å‚™å¿˜</button>
            </div>
        </div>

        <div id="section-itinerary" class="pt-4">
            <div id="list-itinerary" class="pl-2 relative space-y-6 min-h-[200px]"></div>
            <div id="btn-itin-add-container" class="flow-btn-container">
                 <button onclick="window.app.openItineraryModal()" class="big-action-btn btn-orange"><i data-lucide="plus-circle" class="w-5 h-5"></i> æ–°å¢è¡Œç¨‹</button>
            </div>
        </div>
    </div>

    <!-- 2. è¡Œæ -->
    <div id="view-packing" class="hidden-view">
        <div class="sticky-header-safe header-bar">
            <button onclick="window.app.goHome()" class="back-btn"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h2 class="font-black text-2xl tracking-tight text-stone-900">PACKING</h2>
        </div>
        <div id="packing-container" class="space-y-6"></div>
        <div class="flow-btn-container">
             <button onclick="document.getElementById('dialog-packing').showModal()" class="big-action-btn hover:bg-stone-100 transition-colors"><i data-lucide="package-plus" class="w-5 h-5"></i> æ–°å¢ç‰©å“</button>
        </div>
    </div>

    <!-- 3. æ…¾æœ›æ¸…å–® -->
    <div id="view-wishlist" class="hidden-view">
        <div class="sticky-header-safe header-bar">
            <button onclick="window.app.goHome()" class="back-btn"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h2 class="font-black text-2xl tracking-tight text-stone-900">WISHLIST</h2>
            <div class="flex gap-2 bg-white/80 backdrop-blur p-1.5 rounded-2xl border-2 border-stone-200">
                <button onclick="window.app.switchView('itinerary')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="map" class="w-5 h-5"></i></button>
                <button onclick="window.app.switchView('mustbuy')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="shopping-bag" class="w-5 h-5"></i></button>
            </div>
        </div>
        <div id="list-wishlist" class="space-y-6"></div>
        <div class="flow-btn-container">
             <button onclick="window.app.openWishlistModal()" class="big-action-btn hover:bg-stone-100 transition-colors"><i data-lucide="heart-handshake" class="w-5 h-5"></i> æ–°å¢æ…¾æœ›</button>
        </div>
    </div>

    <!-- 4. å¿…è²·æ¸…å–® -->
    <div id="view-mustbuy" class="hidden-view">
        <div class="sticky-header-safe header-bar">
            <button onclick="window.app.goHome()" class="back-btn"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h2 class="font-black text-2xl tracking-tight text-stone-900">MUST BUY</h2>
            <div class="flex gap-2 bg-white/80 backdrop-blur p-1.5 rounded-2xl border-2 border-stone-200">
                <button onclick="window.app.switchView('itinerary')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="map" class="w-5 h-5"></i></button>
                <button onclick="window.app.switchView('wishlist')" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-stone-200 bg-white text-stone-400"><i data-lucide="heart" class="w-5 h-5"></i></button>
            </div>
        </div>
        <div id="mustbuy-container" class="space-y-6"></div>
        <div class="flow-btn-container">
             <button onclick="window.app.openMustBuyModal()" class="big-action-btn hover:bg-stone-100 transition-colors"><i data-lucide="shopping-cart" class="w-5 h-5"></i> æ–°å¢å¿…è²·</button>
        </div>
    </div>

</div>

<!-- FAB -->
<button id="fab-calc" onclick="window.app && window.app.openCalculator()" class="fab-calc hidden">
    <i data-lucide="calculator" class="w-8 h-8"></i>
</button>

<!-- æ—…ç¨‹IDåˆ‡æ›å½ˆçª— -->
<dialog id="dialog-trip-id" class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-2 border-stone-200 w-80">
    <div class="text-center">
        <h3 class="font-black text-xl text-stone-800 mb-2">SWITCH TRIP</h3>
        <p class="text-xs text-stone-500 font-bold mb-4">è¼¸å…¥æ–°çš„ ID ä»¥å»ºç«‹æˆ–åˆ‡æ›æ—…ç¨‹<br>(åŸæœ¬çš„è³‡æ–™ä¸æœƒæ¶ˆå¤±)</p>
        <input type="text" id="trip-id-input" class="w-full bg-stone-50 p-3 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900 mb-4 text-center" placeholder="ä¾‹å¦‚: osaka_2024">
        <div id="trip-history" class="mb-4 flex flex-wrap gap-2 justify-center"></div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('dialog-trip-id').close()" class="flex-1 py-3 font-bold text-stone-500 bg-stone-100 rounded-xl">CANCEL</button>
            <button onclick="window.app.confirmTripId()" class="flex-1 py-3 font-bold text-white bg-stone-900 rounded-xl">GO!</button>
        </div>
    </div>
</dialog>

<!-- å·¥å…·ç®±å½ˆçª— -->
<dialog id="dialog-tools" class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-2 border-stone-200 w-80">
    <div class="flex justify-between items-center mb-6">
        <h3 class="font-black text-xl text-stone-800">TOOLS</h3>
        <button type="button" onclick="document.getElementById('dialog-tools').close()" class="p-2 bg-stone-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>
    <div class="space-y-3">
        <a href="https://www.vjw.digital.go.jp/" target="_blank" class="block w-full bg-stone-50 hover:bg-stone-100 p-4 rounded-xl border-2 border-stone-200 font-bold text-stone-800 flex items-center"><span class="text-2xl mr-3">ğŸ‡¯ğŸ‡µ</span> Visit Japan Web</a>
        <a href="https://translate.google.com/?sl=auto&tl=zh-TW&op=translate" target="_blank" class="block w-full bg-stone-50 hover:bg-stone-100 p-4 rounded-xl border-2 border-stone-200 font-bold text-stone-800 flex items-center"><span class="text-2xl mr-3">ğŸ—£ï¸</span> Google Translate</a>
        <a href="https://world.jorudan.co.jp/mln/zh-tw/" target="_blank" class="block w-full bg-stone-50 hover:bg-stone-100 p-4 rounded-xl border-2 border-stone-200 font-bold text-stone-800 flex items-center"><span class="text-2xl mr-3">ğŸš‡</span> è½‰ä¹˜æ¡ˆå…§ (Jorudan)</a>
        <a href="https://tenki.jp/" target="_blank" class="block w-full bg-stone-50 hover:bg-stone-100 p-4 rounded-xl border-2 border-stone-200 font-bold text-stone-800 flex items-center"><span class="text-2xl mr-3">â˜ï¸</span> å¤©æ°£é å ± (Tenki.jp)</a>
        <a href="https://rate.bot.com.tw/xrt?Lang=zh-TW" target="_blank" class="block w-full bg-stone-50 hover:bg-stone-100 p-4 rounded-xl border-2 border-stone-200 font-bold text-stone-800 flex items-center"><span class="text-2xl mr-3">ğŸ’±</span> å°ç£éŠ€è¡ŒåŒ¯ç‡</a>
    </div>
</dialog>

<!-- éŒ¯èª¤æç¤º -->
<dialog id="dialog-alert" class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-4 border-stone-900 w-80">
    <div class="text-center">
        <h3 class="font-black text-xl text-stone-900 mb-2">NOTICE</h3>
        <p id="alert-msg" class="text-stone-600 text-sm font-bold mb-6"></p>
        <button onclick="document.getElementById('dialog-alert').close()" class="w-full py-3 font-black text-white bg-stone-900 rounded-xl">OK</button>
    </div>
</dialog>

<!-- è¨ˆç®—æ©Ÿ (Layout Updated) -->
<dialog id="dialog-calculator">
    <div class="bg-white rounded-[24px] p-4 m-2 shadow-2xl border-4 border-stone-900 w-[340px]">
        <div class="flex justify-between items-center mb-4">
            <div class="text-xs font-bold text-stone-400 uppercase tracking-widest">Calculator</div>
            <button type="button" onclick="document.getElementById('dialog-calculator').close()" class="p-2 bg-stone-100 rounded-full active:bg-stone-200"><i data-lucide="x" class="w-5 h-5 text-stone-600"></i></button>
        </div>
        
        <!-- é¡¯ç¤ºå€åŸŸ -->
        <div class="bg-stone-100 rounded-xl px-3 py-4 mb-4 text-right border-2 border-stone-200">
            <!-- ç®—å¼/çµæœ -->
            <input type="text" id="calc-display" class="bg-transparent text-4xl font-black text-right outline-none text-stone-900 tracking-tighter w-full mb-1" placeholder="0" readonly>
            <!-- åŒ¯ç‡æ›ç®—çµæœ -->
            <div class="text-orange-500 font-bold text-lg border-t border-stone-200 pt-2 flex justify-end items-center gap-2">
                <span class="text-[10px] bg-orange-100 text-orange-600 px-1 rounded">â‰ˆ TWD</span>
                <span id="calc-res">0</span>
            </div>
        </div>
        
        <button type="button" onclick="window.app.toggleCurrency()" class="w-full mb-4 py-3 bg-stone-900 rounded-xl text-white text-xs font-bold flex items-center justify-center gap-2 active:bg-stone-700 shadow-[2px_2px_0_#ea580c] transition-transform active:translate-y-[1px] active:shadow-none border-2 border-stone-900">
            <span id="calc-mode-text">JPY â†’ TWD</span> <i data-lucide="arrow-left-right" class="w-3 h-3"></i>
        </button>

        <!-- éµç›¤å€åŸŸ -->
        <div class="calc-grid">
            <!-- Row 1 -->
            <button class="calc-btn calc-btn-func" onclick="window.app.calcClear()">AC</button>
            <button class="calc-btn calc-btn-func" onclick="window.app.calcDel()"><i data-lucide="delete" class="w-6 h-6"></i></button>
            <button class="calc-btn calc-btn-func" onclick="window.app.calcAppend('%')">%</button>
            <button class="calc-btn calc-btn-op" onclick="window.app.calcAppend('/')">Ã·</button>
            
            <!-- Row 2 -->
            <button class="calc-btn calc-btn-num" onclick="window.app.calcAppend('7')">7</button>
            <button class="calc-btn calc-btn-num" onclick="window.app.calcAppend('8')">8</button>
            <button class="calc-btn calc-btn-num" onclick="window.app.calcAppend('9')">9</button>
            <button class="calc-btn calc-btn-op" onclick="window.app.calcAppend('*')">Ã—</button>
            
            <!-- Row 3 -->
            <button class="calc-btn calc-btn-num" onclick="window.app.calcAppend('4')">4</button>
            <button class="calc-btn calc-btn-num" onclick="window.app.calcAppend('5')">5</button>
            <button class="calc-btn calc-btn-num" onclick="window.app.calcAppend('6')">6</button>
            <button class="calc-btn calc-btn-op" onclick="window.app.calcAppend('-')">âˆ’</button>
            
            <!-- Row 4 -->
            <button class="calc-btn calc-btn-num" onclick="window.app.calcAppend('1')">1</button>
            <button class="calc-btn calc-btn-num" onclick="window.app.calcAppend('2')">2</button>
            <button class="calc-btn calc-btn-num" onclick="window.app.calcAppend('3')">3</button>
            <button class="calc-btn calc-btn-op" onclick="window.app.calcAppend('+')">+</button>
            
            <!-- Row 5 -->
            <button class="calc-btn calc-btn-num calc-btn-zero" onclick="window.app.calcAppend('0')">0</button>
            <button class="calc-btn calc-btn-num" onclick="window.app.calcAppend('.')">.</button>
            <button class="calc-btn calc-btn-eq" onclick="window.app.calcEval()">=</button>
        </div>
    </div>
</dialog>

<!-- ... (Memo, Packing, Wishlist, Mustbuy, Itinerary modals unchanged) ... -->
<!-- [ä¿ç•™å…ˆå‰çš„å½ˆçª—ä»£ç¢¼] -->
<!-- è¡Œç¨‹å½ˆçª— -->
<dialog id="dialog-itinerary">
    <div class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-2 border-stone-200 relative">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-black text-xl text-stone-800">EDIT PLAN</h3>
            <div class="flex gap-2">
                 <button type="button" onclick="window.app.deleteItinerary()" id="btn-del-itin" class="hidden p-3 bg-red-50 text-red-500 rounded-full hover:bg-red-100 border border-red-100 active:bg-red-200" style="z-index:999;"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                 <button type="button" onclick="document.getElementById('dialog-itinerary').close()" class="p-2 bg-stone-100 rounded-full" style="z-index:999;"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
        </div>
        <form id="form-itinerary" onsubmit="window.app.saveItinerary(event)" class="space-y-4">
            <input type="hidden" id="itin-id">
            <div class="bg-stone-50 p-3 rounded-xl border border-stone-200">
                <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">Date</label>
                <input type="date" id="itin-date" class="w-full bg-transparent font-bold text-stone-800 outline-none text-lg" required>
            </div>
            
            <div id="field-flight" class="hidden grid grid-cols-2 gap-3 bg-stone-50 p-3 rounded-xl border border-stone-200">
                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">From</label>
                    <input type="text" id="itin-dep-code" placeholder="TPE" class="w-full font-bold bg-transparent outline-none uppercase">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">To</label>
                    <input type="text" id="itin-arr-code" placeholder="TYO" class="w-full font-bold bg-transparent outline-none uppercase">
                </div>
            </div>

            <div class="flex gap-3">
                <div class="w-1/3">
                     <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">Start</label>
                     <input type="time" id="itin-time" class="bg-stone-50 p-3 rounded-xl w-full text-center font-bold outline-none border border-stone-200 focus:border-stone-900">
                </div>
                <div class="w-1/3">
                     <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">End (Opt)</label>
                     <input type="time" id="itin-end-time" class="bg-stone-50 p-3 rounded-xl w-full text-center font-bold outline-none border border-stone-200 focus:border-stone-900">
                </div>
                <div class="w-1/3">
                     <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">Type</label>
                     <select id="itin-cat" onchange="window.app.onCatChange(this.value)" class="bg-stone-50 p-3 rounded-xl w-full font-bold outline-none border border-stone-200 focus:border-stone-900">
                        <option value="æ™¯é»">æ™¯é»</option>
                        <option value="ç¾é£Ÿ">ç¾é£Ÿ</option>
                        <option value="è³¼ç‰©">è³¼ç‰©</option>
                        <option value="ä½å®¿">ä½å®¿</option>
                        <option value="äº¤é€š">äº¤é€š</option>
                        <option value="èˆªç­">èˆªç­</option>
                    </select>
                </div>
            </div>
            
            <div id="field-nights" class="hidden">
                 <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">Nights (Auto Copy)</label>
                 <input type="number" id="itin-nights" value="1" min="1" max="14" class="w-full bg-stone-50 p-3 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900">
            </div>

            <input type="text" id="itin-title" placeholder="åç¨±" class="w-full bg-stone-50 p-4 rounded-xl font-black text-lg outline-none border-2 border-stone-200 focus:border-stone-900" required>
            <textarea id="itin-note" placeholder="å‚™è¨»..." class="w-full bg-stone-50 p-3 rounded-xl text-sm outline-none border border-stone-200 focus:border-stone-900 h-24 resize-none"></textarea>
            <div class="relative">
                <i data-lucide="map-pin" class="absolute left-3 top-3.5 w-4 h-4 text-stone-400"></i>
                <input type="text" id="itin-map" placeholder="Google Maps é€£çµ" class="w-full bg-stone-50 p-3 pl-10 rounded-xl text-sm outline-none border border-stone-200 focus:border-stone-900 text-blue-600 font-bold">
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-grow bg-stone-900 text-white font-bold py-4 rounded-lg shadow-[4px_4px_0px_#f97316] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all border-2 border-stone-900">SAVE</button>
            </div>
        </form>
    </div>
</dialog>

<!-- å…¶ä»– Modal åŒå‰ä¸€ç‰ˆï¼Œç•¥éä»¥ç¯€çœç©ºé–“ï¼ŒåŠŸèƒ½é‚è¼¯å®Œå…¨ä¿ç•™ -->
<!-- (Packing, Wishlist, Mustbuy, Memo) -->
<dialog id="dialog-packing">
    <div class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-2 border-stone-200">
         <div class="flex justify-between items-center mb-4">
            <h3 class="font-black text-xl text-stone-800">ADD ITEM</h3>
            <button type="button" onclick="document.getElementById('dialog-packing').close()" class="p-2 bg-stone-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
         </div>
         <form onsubmit="window.app.savePacking(event)" class="space-y-3">
             <select id="pack-cat" class="w-full bg-stone-50 p-3 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900">
                <option value="è­‰ä»¶éŒ¢åŒ…">è­‰ä»¶éŒ¢åŒ…</option>
                <option value="è¡£ç‰©ç©¿æ­">è¡£ç‰©ç©¿æ­</option>
                <option value="é›»å­ç”¢å“">é›»å­ç”¢å“</option>
                <option value="è—¥å“é›œç‰©">è—¥å“é›œç‰©</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
             </select>
             <input type="text" id="pack-name" placeholder="ç‰©å“åç¨±" class="w-full bg-stone-50 p-4 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900" required>
             <button type="submit" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg shadow-[4px_4px_0px_#10b981] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all border-2 border-stone-900 mt-2">ADD</button>
         </form>
    </div>
</dialog>

<dialog id="dialog-wishlist">
    <div class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-2 border-stone-200">
         <div class="flex justify-between items-center mb-4">
            <h3 class="font-black text-xl text-stone-800">WISH ITEM</h3>
            <button type="button" onclick="document.getElementById('dialog-wishlist').close()" class="p-2 bg-stone-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
         </div>
         <form onsubmit="window.app.saveWishlist(event)" class="space-y-3">
             <input type="hidden" id="wish-id">
             <input type="text" id="wish-location" placeholder="åœ°é»" class="w-full bg-stone-50 p-4 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900" required>
             <input type="text" id="wish-item" placeholder="é …ç›®" class="w-full bg-stone-50 p-4 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900" required>
             <div class="relative">
                <i data-lucide="map-pin" class="absolute left-3 top-3.5 w-4 h-4 text-stone-400"></i>
                <input type="text" id="wish-link" placeholder="å‚™è¨»æˆ–é€£çµ" class="w-full bg-stone-50 p-3 pl-10 rounded-xl text-sm outline-none border border-stone-200 focus:border-stone-900 font-bold">
            </div>
             <label class="file-upload-label">
                 <i data-lucide="camera" class="w-5 h-5"></i> åœ–ç‰‡ (é¸å¡«)
                 <input type="file" id="wish-image" accept="image/*" class="hidden">
             </label>
             <div class="flex gap-2">
                 <label class="flex-1 bg-stone-50 border-2 border-stone-200 rounded-xl p-3 flex items-center justify-center cursor-pointer has-[:checked]:border-stone-900 has-[:checked]:bg-stone-100">
                     <input type="radio" name="wish-type" value="eat" checked class="hidden">
                     <span class="font-bold text-sm"><i data-lucide="utensils" class="w-4 h-4 inline mr-1"></i> EAT</span>
                 </label>
                 <label class="flex-1 bg-stone-50 border-2 border-stone-200 rounded-xl p-3 flex items-center justify-center cursor-pointer has-[:checked]:border-stone-900 has-[:checked]:bg-stone-100">
                     <input type="radio" name="wish-type" value="buy" class="hidden">
                     <span class="font-bold text-sm"><i data-lucide="shopping-bag" class="w-4 h-4 inline mr-1"></i> BUY</span>
                 </label>
             </div>
             <button type="submit" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg shadow-[4px_4px_0px_#f97316] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all border-2 border-stone-900 mt-2">SAVE</button>
         </form>
    </div>
</dialog>

<dialog id="dialog-mustbuy">
    <div class="bg-white rounded-[24px] p-5 m-2 shadow-2xl border-2 border-stone-200">
         <div class="flex justify-between items-center mb-4">
            <h3 class="font-black text-xl text-stone-800">MUST BUY ITEM</h3>
            <button type="button" onclick="document.getElementById('dialog-mustbuy').close()" class="p-2 bg-stone-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
         </div>
         <form onsubmit="window.app.saveMustBuy(event)" class="space-y-3">
             <input type="hidden" id="mb-id">
             <div class="relative">
                 <input type="text" id="mb-category" list="mb-cat-list" placeholder="åˆ†é¡ (ä¾‹: é€å®¶äºº)" class="w-full bg-stone-50 p-4 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900" required>
                 <datalist id="mb-cat-list">
                     <option value="è‡ªç”¨ / è£œè²¨"></option>
                     <option value="é€å®¶äºº / é•·è¼©"></option>
                     <option value="é€æœ‹å‹ / åŒäº‹"></option>
                     <option value="ä»£è³¼ / å…¶ä»–"></option>
                 </datalist>
             </div>
             <input type="text" id="mb-name" placeholder="å•†å“åç¨±" class="w-full bg-stone-50 p-4 rounded-xl font-bold outline-none border border-stone-200 focus:border-stone-900" required>
             <input type="text" id="mb-details" placeholder="å‚™è¨»" class="w-full bg-stone-50 p-4 rounded-xl text-sm outline-none border border-stone-200 focus:border-stone-900">
             <label class="file-upload-label">
                 <i data-lucide="camera" class="w-5 h-5"></i> åœ–ç‰‡ (é¸å¡«)
                 <input type="file" id="mb-image" accept="image/*" class="hidden">
             </label>
             <button type="submit" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg shadow-[4px_4px_0px_#f97316] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all border-2 border-stone-900 mt-2">SAVE</button>
         </form>
    </div>
</dialog>

<!-- Firebase & Logic (Updated with calc fix) -->
<script type="module">
    // ... [ä¿ç•™åŸæœ¬çš„ Firebase Config] ...
    window.onerror = function(msg, url, line) {
        const toast = document.getElementById('error-toast');
        toast.style.display = 'block';
        toast.innerText = `ERROR: ${msg} (Line ${line})`;
        return false;
    };

    const firebaseConfig = {
      apiKey: "AIzaSyCFbodSlPH_CBmQrISVVyyBgQmn7golSZI",
      authDomain: "travel-fc0fd.firebaseapp.com",
      projectId: "travel-fc0fd",
      storageBucket: "travel-fc0fd.firebasestorage.app",
      messagingSenderId: "648761523272",
      appId: "1:648761523272:web:a3c62013ff13cdc43dac7d"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let fbApp, auth, db;
    try {
        fbApp = initializeApp(firebaseConfig);
        auth = getAuth(fbApp);
        db = getFirestore(fbApp);
    } catch (e) {
        console.error("Firebase init error", e);
    }
    
    const DEFAULT_TRIP_ID = "tokyo_trip_shared";
    let currentTripId = localStorage.getItem('currentTripId') || DEFAULT_TRIP_ID;
    
    let userId = null;
    let activeDate = '2025-12-14';
    let cachedItinerary = [];
    let cachedWishlist = [];
    let cachedMustBuy = [];
    let memoList = []; 
    let calcVal = '0';
    let currentRate = 0.22;
    // [Fix] Removed local calcMode variable, will use uiApp.calcMode
    let sortableInstance = null;

    const petPhotos = [
        "1.jpg", "2.jpg", "3.jpg", "4.jpg", "5.jpg",
        "6.jpg", "7.jpg", "8.jpg", "9.jpg", "10.jpg"
    ];

    const compressImage = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    const scaleSize = MAX_WIDTH / img.width;
                    if (img.width > MAX_WIDTH) {
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                    } else {
                        canvas.width = img.width;
                        canvas.height = img.height;
                    }
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
                    resolve(dataUrl);
                }
            }
            reader.onerror = (error) => reject(error);
        });
    };

    const uiApp = {
        calcMode: 'JPY_TWD', // [Fix] Moved inside object to avoid scope issues

        init(user) {
            userId = user.uid;
            const dot = document.getElementById('auth-status-dot');
            const txt = document.getElementById('auth-status-text');
            if (dot) dot.classList.replace('bg-gray-300', 'bg-green-500');
            if (txt) txt.innerText = 'ONLINE';
            this.updateTitle();
            this.startListeners();
            this.updateRate();
            this.startSlideshow();
        },
        
        // ... (å…¶ä»–å‡½å¼ä¿æŒä¸è®Šï¼Œçœç•¥ä»¥ç¯€çœé•·åº¦ï¼Œè«‹ä¿ç•™åŸæœ‰çš„ initOffline, updateTitle, openTripIdModal ç­‰)
        initOffline(guestId) {
            userId = guestId;
            document.getElementById('auth-status-text').innerText = 'OFFLINE';
            document.getElementById('auth-status-dot').classList.replace('bg-gray-300', 'bg-orange-400');
            this.startSlideshow();
            this.updateRate();
        },

        updateTitle() {
            let displayTitle = currentTripId.replace('_trip_shared', '').toUpperCase();
            if(displayTitle.includes('_')) displayTitle = displayTitle.split('_')[0];
            document.getElementById('home-title').innerHTML = `${displayTitle}<span class="text-orange-500">.</span>`;
        },

        openTripIdModal() {
            document.getElementById('trip-id-input').value = currentTripId;
            const historyDiv = document.getElementById('trip-history');
            const history = this.getTripHistory();
            historyDiv.innerHTML = history.map(id => 
                `<button onclick="document.getElementById('trip-id-input').value = '${id}'; window.app.confirmTripId()" class="px-3 py-1 bg-stone-100 text-xs font-bold rounded-lg text-stone-500 hover:bg-stone-200 border border-stone-200 uppercase">${id}</button>`
            ).join('');
            document.getElementById('dialog-trip-id').showModal();
        },

        getTripHistory() {
             try {
                return JSON.parse(localStorage.getItem('tripHistory')) || [DEFAULT_TRIP_ID];
            } catch { return [DEFAULT_TRIP_ID]; }
        },
        
        confirmTripId() {
            const newId = document.getElementById('trip-id-input').value;
            if(newId && newId.trim() !== "") {
                currentTripId = newId.trim();
                localStorage.setItem('currentTripId', currentTripId);
                let history = this.getTripHistory();
                if (!history.includes(currentTripId)) {
                    history.unshift(currentTripId);
                    if(history.length > 5) history.pop();
                    localStorage.setItem('tripHistory', JSON.stringify(history));
                }
                location.reload(); 
            }
        },

        openTools() {
            document.getElementById('dialog-tools').showModal();
        },

        showCustomAlert(msg) {
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('dialog-alert').showModal();
        },

        getCol(name) { return collection(db, 'trips', currentTripId, name); },
        getDocRef(colName, docId) { return doc(db, 'trips', currentTripId, colName, docId); },

        switchView(view) {
            document.getElementById('view-home').classList.add('hidden-view');
            document.getElementById('view-home').classList.remove('active-view');
            
            ['itinerary', 'packing', 'wishlist', 'mustbuy'].forEach(v => {
                const el = document.getElementById('view-' + v);
                if (el) {
                    if(v === view) { el.classList.remove('hidden-view'); el.classList.add('active-view'); } 
                    else { el.classList.add('hidden-view'); el.classList.remove('active-view'); }
                }
            });

            const fab = document.getElementById('fab-calc');
            if(view === 'view-home') fab.style.display = 'none';
            else fab.style.display = 'flex';
            
            if(view === 'itinerary') uiApp.renderItinerary();
            if(window.lucide) window.lucide.createIcons();
        },
        
        goHome() {
            document.querySelectorAll('.active-view').forEach(el => { el.classList.add('hidden-view'); el.classList.remove('active-view'); });
            document.getElementById('view-home').classList.remove('hidden-view');
            document.getElementById('view-home').classList.add('active-view');
            document.getElementById('fab-calc').style.display = 'none';
        },
        // ... (startListeners ä¿æŒä¸è®Š)
        startListeners() {
            if(!db || !userId) return;
            try {
                const qItin = query(uiApp.getCol('itinerary'), orderBy('date'));
                onSnapshot(qItin, (snap) => {
                    cachedItinerary = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    cachedItinerary.sort((a, b) => {
                        const d = a.date.localeCompare(b.date);
                        if(d !== 0) return d;
                        
                        // ä½å®¿æ’åœ¨æœ€å¾Œ
                        const isHotelA = a.cat === 'ä½å®¿';
                        const isHotelB = b.cat === 'ä½å®¿';
                        if (isHotelA && !isHotelB) return 1;
                        if (!isHotelA && isHotelB) return -1;

                        const tA = a.time || '';
                        const tB = b.time || '';
                        if (tA !== tB) return tA.localeCompare(tB);
                        if (a.order !== undefined && b.order !== undefined) return a.order - b.order;
                        return 0;
                    });
                    uiApp.renderItinerary();
                });

                onSnapshot(query(uiApp.getCol('memos'), orderBy('createdAt')), (snap) => {
                    memoList = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    uiApp.renderMemo(memoList);
                });
                onSnapshot(query(uiApp.getCol('packing')), (snap) => uiApp.renderPacking(snap.docs.map(d=>({id:d.id, ...d.data()}))));
                onSnapshot(query(uiApp.getCol('wishlist'), orderBy('createdAt')), (snap) => {
                    cachedWishlist = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    uiApp.renderWishlist(cachedWishlist);
                });
                onSnapshot(query(uiApp.getCol('mustbuy'), orderBy('createdAt')), (snap) => {
                    cachedMustBuy = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    uiApp.renderMustBuy(cachedMustBuy);
                });
            } catch(e) { console.error("Listener init failed", e); }
        },

        onCatChange(val) {
             const flightFields = document.getElementById('field-flight');
             const nightFields = document.getElementById('field-nights');
             if(val === 'èˆªç­') {
                 flightFields.classList.remove('hidden');
                 nightFields.classList.add('hidden');
             } else if(val === 'ä½å®¿') {
                 flightFields.classList.add('hidden');
                 nightFields.classList.remove('hidden');
             } else {
                 flightFields.classList.add('hidden');
                 nightFields.classList.add('hidden');
             }
        },
        
        renderItinerary() {
            const container = document.getElementById('list-itinerary');
            // ... (renderItinerary å…§å®¹ä¿æŒä¸è®Šï¼Œçœç•¥)
            const tabs = document.getElementById('nav-dates');
            if(!container) return;
            
            if(sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }

            const uniqueDates = [...new Set(cachedItinerary.map(i => i.date))].sort();
            let allDates = [];

            if (uniqueDates.length > 0) {
                const minDate = new Date(uniqueDates[0]);
                const maxDate = new Date(uniqueDates[uniqueDates.length - 1]);
                for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) {
                    allDates.push(d.toISOString().split('T')[0]);
                }
            } else {
                allDates.push(new Date().toISOString().split('T')[0]);
            }
            
            let tabsHtml = `<div onclick="window.app.switchDate('0')" class="date-tab ${activeDate==='0'?'active':''}"><span class="day-label">ALL</span><span class="date-num">â˜…</span></div>`;
            tabsHtml += allDates.map(d => {
                const dateObj = new Date(d);
                return `<div onclick="window.app.switchDate('${d}')" class="date-tab ${activeDate===d?'active':''}"><span class="day-label">${dateObj.toLocaleDateString('en-US',{month:'short'}).toUpperCase()}</span><span class="date-num">${dateObj.getDate()}</span></div>`;
            }).join('');
            tabs.innerHTML = tabsHtml;
            
            if(activeDate !== '0' && !allDates.includes(activeDate) && allDates.length > 0) {
                activeDate = allDates[0];
            }

            const isPre = activeDate === '0';
            document.getElementById('section-memo').className = isPre ? 'block' : 'hidden';
            document.getElementById('section-itinerary').className = isPre ? 'hidden' : 'block';
            document.getElementById('btn-itin-add-container').style.display = isPre ? 'none' : 'flex';
            
            const weatherHeader = document.getElementById('date-weather-header');
            const headerDate = document.getElementById('header-date');
            const headerWeather = document.getElementById('header-weather');

            if(!isPre) {
                weatherHeader.classList.remove('hidden');
                const items = cachedItinerary.filter(i => i.date === activeDate);
                const dateObj = new Date(activeDate);
                
                headerDate.innerText = `${dateObj.toLocaleDateString('en-US', {weekday:'long'})}`;
                
                uiApp.fetchWeather(activeDate, (wCode, temp) => {
                    let iconName = 'cloud';
                    if (wCode <= 1) iconName = 'sun';
                    else if (wCode <= 3) iconName = 'cloud-sun';
                    else if (wCode <= 67) iconName = 'cloud-rain';
                    else if (wCode <= 77) iconName = 'snowflake';
                    else if (wCode >= 95) iconName = 'cloud-lightning';
                    
                    headerWeather.innerHTML = `<i data-lucide="${iconName}" class="w-8 h-8 mr-2 text-stone-600"></i><span class="text-2xl font-bold">${temp}</span>`;
                    if(window.lucide) window.lucide.createIcons();
                });

                let html = `<div id="timeline-sortable" class="timeline-container relative pb-10">`; 
                if(items.length === 0) html += `<div class="text-stone-400 text-center py-10 font-bold">NO PLANS YET</div>`;
                
                items.forEach(item => {
                    const handleHtml = `<div class="drag-handle absolute right-2 top-2 p-2 touch-none cursor-grab hover:bg-stone-100 rounded-full transition-colors"><i data-lucide="menu" class="w-5 h-5 text-stone-300"></i></div>`;
                    
                    const hasNote = item.note && item.note.trim().length > 0;
                    const noteId = `note-${item.id}`;
                    const noteIndicator = hasNote ? `<button onclick="event.stopPropagation(); document.getElementById('${noteId}').classList.toggle('hidden')" class="ml-2 text-orange-400 hover:text-orange-600 transition-colors p-1"><i data-lucide="sticky-note" class="w-4 h-4"></i></button>` : '';
                    const noteHtml = hasNote ? `<div id="${noteId}" class="hidden mt-3 text-sm text-stone-600 font-medium border-l-2 border-orange-200 pl-2 whitespace-pre-wrap animate-fade-in">${item.note}</div>` : '';

                    if(item.cat === 'èˆªç­') {
                         const dep = item.depCode || 'TPE';
                         const arr = item.arrCode || 'TYO';
                         const arrTimeDisplay = item.endTime ? `ARR ${item.endTime}` : '';
                         
                         html += `
                         <div class="timeline-item group" data-id="${item.id}" onclick="window.app.openItineraryModal('${item.id}')">
                            <div class="timeline-line"></div>
                            <div class="bg-white border-2 border-stone-900 rounded-2xl p-4 relative shadow-[4px_4px_0px_#fcd34d] mb-6 ticket-card ml-8 active:scale-98 transition-transform cursor-pointer">
                                ${handleHtml}
                                <div class="flex justify-between items-center mb-4 border-b-2 border-dashed border-stone-300 pb-2">
                                    <div class="font-mono font-bold text-stone-500 text-xs flex items-center">FLIGHT TICKET ${noteIndicator}</div>
                                    <div class="font-mono font-black text-stone-300 text-xs tracking-widest uppercase pr-2">BOARDING PASS</div>
                                </div>
                                <div class="flex justify-between items-center mb-2">
                                    <div class="text-center">
                                        <div class="text-4xl font-black text-stone-900">${dep}</div>
                                        <div class="text-xs font-bold text-stone-400 mt-1">DEP ${item.time || '--:--'}</div>
                                    </div>
                                    <div class="flex-grow px-4 text-center relative">
                                        <div class="border-t-2 border-stone-300 absolute top-1/2 left-4 right-4 -translate-y-1/2"></div>
                                        <i data-lucide="plane" class="text-stone-900 w-6 h-6 relative z-10 bg-white px-1 mx-auto rotate-90"></i>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-4xl font-black text-stone-900">${arr}</div>
                                        <div class="text-xs font-bold text-stone-400 mt-1">${arrTimeDisplay}</div>
                                    </div>
                                </div>
                                <div class="text-center mt-4 pt-2 border-t-2 border-dashed border-stone-100 font-bold text-stone-600 bg-stone-50 rounded-lg py-2">
                                    ${item.title || 'FLIGHT'}
                                </div>
                                ${noteHtml}
                            </div>
                         </div>`;
                    } else if(item.cat === 'äº¤é€š') {
                        html += `<div class="timeline-item" data-id="${item.id}" onclick="window.app.openItineraryModal('${item.id}')">
                            <div class="timeline-line"></div>
                            <div class="flex items-center gap-3 mb-4 timeline-content-wrapper">
                                <div class="w-12 h-12 bg-stone-900 rounded-full flex items-center justify-center text-white z-10 border-2 border-white flex-shrink-0 shadow-md"><i data-lucide="bus" class="w-6 h-6"></i></div>
                                <div class="bg-stone-200 px-3 py-2 rounded-lg text-xs font-bold text-stone-600 flex-grow relative pr-10 group active:scale-98 transition-transform cursor-pointer">
                                    ${item.time} ${item.title} <span class="opacity-50 flex items-center inline-block align-middle">${noteIndicator}</span>
                                    <div class="drag-handle absolute right-1 top-1/2 -translate-y-1/2 p-2 touch-none cursor-grab"><i data-lucide="menu" class="w-4 h-4 text-stone-400"></i></div>
                                    ${noteHtml}
                                </div>
                            </div></div>`;
                    } else {
                        const isHotel = item.cat === 'ä½å®¿';
                        const dotStyle = isHotel ? 'background:#f97316; border-color:#1c1917;' : '';
                        
                        const mapUrl = item.map ? item.map : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}`;
                        const mapBtn = `<div class="flex gap-2 mt-3"><a href="${mapUrl}" target="_blank" onclick="event.stopPropagation()" class="w-full bg-stone-100 hover:bg-stone-900 hover:text-white text-stone-600 py-3 rounded-lg text-xs font-black border border-stone-200 transition-colors flex items-center justify-center tracking-wider shadow-sm gap-2"><i data-lucide="map" class="w-3 h-3"></i> MAP â†—</a></div>`;

                        html += `<div class="timeline-item group cursor-pointer" data-id="${item.id}" onclick="window.app.openItineraryModal('${item.id}')">
                            <div class="timeline-line"></div>
                            <div class="timeline-dot" style="${dotStyle}"></div>
                            <div class="flex gap-4 mb-6 timeline-content-wrapper">
                                <div class="w-12 text-right pt-1 font-mono font-bold text-stone-600 text-sm flex-shrink-0">${item.time || ''}</div>
                                <div class="flex-grow card-marble p-4 relative active:scale-98 transition-transform">
                                    ${handleHtml}
                                    <div class="flex justify-between items-start mb-1"><h3 class="font-black text-xl uppercase leading-tight pr-8">${item.title}</h3></div>
                                    <div class="text-xs font-bold text-stone-400 mb-1 flex items-center">#${item.cat} ${noteIndicator}</div>
                                    ${noteHtml}
                                    ${mapBtn}
                                </div>
                            </div>
                        </div>`;
                    }
                });
                html += `</div>`;
                container.innerHTML = html;

                const sortEl = document.getElementById('timeline-sortable');
                if(sortEl) {
                    sortableInstance = new Sortable(sortEl, {
                        handle: '.drag-handle',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        delay: 0,
                        delayOnTouchOnly: false,
                        onEnd: function(evt) {
                            window.app.updateItineraryOrder();
                        }
                    });
                }
            } else {
                weatherHeader.classList.add('hidden');
            }
            if(window.lucide) window.lucide.createIcons();
        },
        switchDate(d) { activeDate = d; uiApp.renderItinerary(); },
        async fetchWeather(dateStr, cb) { try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&daily=weathercode,temperature_2m_max&timezone=Asia%2FTokyo&start_date=${dateStr}&end_date=${dateStr}`); const data = await res.json(); const code = data.daily.weathercode[0]; const temp = data.daily.temperature_2m_max[0]; cb(code, `${Math.round(temp)}Â°C`); } catch(e) { cb(0, ''); } },
        
        renderMemo(items) {
            const list = document.getElementById('list-memo');
            list.innerHTML = items.map(item => `
                <div class="card-marble bg-white p-5 mb-4 relative">
                    <div class="flex justify-between items-start mb-2 border-b-2 border-stone-100 pb-2">
                        <h3 class="font-black text-xl text-stone-900 uppercase">${item.title}</h3>
                        <div class="flex gap-2">
                            <button onclick="window.app.openMemoModal('${item.id}')" class="text-stone-300 hover:text-stone-900"><i data-lucide="edit-2" class="w-5 h-5"></i></button>
                            <button onclick="event.stopPropagation(); window.app.delDoc('memos', '${item.id}')" class="text-stone-300 hover:text-red-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div class="memo-content">${item.content}</div>
                </div>
            `).join('');
            if(window.lucide) window.lucide.createIcons();
        },

        renderPacking(items) {
            const container = document.getElementById('packing-container');
            const cats = ["è­‰ä»¶éŒ¢åŒ…", "è¡£ç‰©ç©¿æ­", "é›»å­ç”¢å“", "è—¥å“é›œç‰©", "å…¶ä»–"];
            container.innerHTML = cats.map(cat => {
                const filtered = items.filter(i => i.category === cat);
                if(filtered.length === 0) return '';
                return `<div class="card-marble p-4 bg-white"><div class="flex justify-between border-b-2 border-stone-100 pb-2 mb-2"><span class="font-black text-sm uppercase text-stone-800">${cat}</span><span class="text-xs font-bold text-stone-500 bg-stone-100 px-2 py-0.5 rounded-full">${filtered.filter(x=>x.checked).length}/${filtered.length}</span></div><div class="space-y-2">${filtered.map(i => `<div class="flex items-center"><input type="checkbox" class="checkbox-industrial mr-3 scale-75" ${i.checked?'checked':''} onchange="window.app.togglePack('${i.id}', this.checked)"><span class="flex-grow text-sm font-bold ${i.checked?'line-through text-stone-300':'text-stone-800'}">${i.name}</span><button type="button" class="p-3 text-stone-300 hover:text-red-500 active:text-red-700" onclick="event.stopPropagation(); window.app.delDoc('packing', '${i.id}')"><i data-lucide="x" class="w-4 h-4"></i></button></div>`).join('')}</div></div>`;
            }).join('');
            if(window.lucide) window.lucide.createIcons();
        },

        renderWishlist(items) {
            const list = document.getElementById('list-wishlist');
            const grouped = items.reduce((acc, item) => { (acc[item.location] = acc[item.location] || []).push(item); return acc; }, {});
            
            if(Object.keys(grouped).length === 0) { list.innerHTML = `<div class="text-center text-stone-400 font-bold py-10">NO WISHES YET</div>`; return; }

            list.innerHTML = Object.keys(grouped).map(loc => `
                <div class="card-marble bg-white p-4">
                    <h3 class="font-black text-lg text-stone-900 border-b-2 border-stone-100 pb-2 mb-3 flex items-center">
                        <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i> ${loc}
                    </h3>
                    <div class="space-y-3">
                        ${grouped[loc].map(i => {
                            let mapLink = '';
                            if(i.link && i.link.trim() !== '') {
                                const url = i.link.startsWith('http') ? i.link : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.location + ' ' + i.name)}`;
                                mapLink = `<a href="${url}" target="_blank" onclick="event.stopPropagation()" class="text-[10px] font-black bg-stone-100 hover:bg-stone-900 hover:text-white text-stone-600 px-2 py-1 rounded ml-2 border border-stone-200 transition-colors">GO â†—</a>`;
                            } else {
                                const searchUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.location + ' ' + i.name)}`;
                                mapLink = `<a href="${searchUrl}" target="_blank" onclick="event.stopPropagation()" class="text-[10px] font-black bg-stone-100 hover:bg-stone-900 hover:text-white text-stone-600 px-2 py-1 rounded ml-2 border border-stone-200 transition-colors">GO â†—</a>`;
                            }

                            const hasImage = i.image && i.image.startsWith('data:image');
                            const detailId = `wish-detail-${i.id}`;

                            return `
                            <div class="bg-stone-50 p-3 rounded-xl border border-stone-100 cursor-pointer hover:bg-stone-100 transition-colors group" onclick="document.getElementById('${detailId}') && document.getElementById('${detailId}').classList.toggle('hidden')">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-3 overflow-hidden">
                                        <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${i.type==='eat'?'bg-orange-100 text-orange-600':'bg-stone-200 text-stone-600'}">
                                            <i data-lucide="${i.type==='eat'?'utensils':'shopping-bag'}" class="w-4 h-4"></i>
                                        </div>
                                        <div class="flex flex-col overflow-hidden">
                                            <div class="flex items-center">
                                                <span class="font-bold text-stone-800 truncate">${i.name}</span>
                                                ${mapLink}
                                            </div>
                                            ${(i.link && !i.link.startsWith('http')) ? `<div class="text-xs text-stone-400 font-bold truncate">${i.link}</div>` : ''}
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 flex items-center">
                                        ${hasImage ? `<i data-lucide="image" class="w-4 h-4 text-stone-300 mr-2"></i>` : ''}
                                        <button onclick="event.stopPropagation(); window.app.openWishlistModal('${i.id}')" class="text-stone-300 hover:text-stone-900 p-2"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                        <button onclick="event.stopPropagation(); window.app.delDoc('wishlist', '${i.id}')" class="text-stone-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                ${hasImage ? `<div id="${detailId}" class="hidden mt-2 animate-fade-in"><img src="${i.image}" class="expanded-image" /></div>` : ''}
                            </div>
                        `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
            if(window.lucide) window.lucide.createIcons();
        },

        renderMustBuy(items) {
            const list = document.getElementById('mustbuy-container');
            
            if(items.length === 0) { list.innerHTML = `<div class="text-center text-stone-400 font-bold py-10">NO ITEMS YET</div>`; return; }

            const grouped = items.reduce((acc, item) => {
                const cat = item.category || 'æœªåˆ†é¡';
                (acc[cat] = acc[cat] || []).push(item);
                return acc;
            }, {});

            const catOrder = ["è‡ªç”¨ / è£œè²¨", "é€å®¶äºº / é•·è¼©", "é€æœ‹å‹ / åŒäº‹", "ä»£è³¼ / å…¶ä»–"];
            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                const idxA = catOrder.indexOf(a);
                const idxB = catOrder.indexOf(b);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                return a.localeCompare(b);
            });

            list.innerHTML = sortedKeys.map(cat => {
                const groupItems = grouped[cat];
                groupItems.sort((a, b) => (a.checked === b.checked) ? 0 : a.checked ? 1 : -1);
                
                const doneCount = groupItems.filter(i => i.checked).length;
                
                return `
                <div class="card-marble bg-white p-4">
                    <div class="flex justify-between border-b-2 border-stone-100 pb-2 mb-2">
                        <span class="font-black text-lg uppercase text-stone-800">${cat}</span>
                        <span class="text-xs font-bold text-stone-500 bg-stone-100 px-2 py-1 rounded-full flex items-center">${doneCount}/${groupItems.length}</span>
                    </div>
                    <div class="space-y-3">
                        ${groupItems.map(i => {
                            const hasDetails = i.details && i.details.trim() !== '';
                            const hasImage = i.image && i.image.startsWith('data:image');
                            let detailContent = '';
                            
                            if(hasDetails) {
                                const isUrl = i.details.startsWith('http');
                                if(isUrl) {
                                    detailContent += `<div class="mt-3 rounded-lg overflow-hidden border-2 border-stone-900"><img src="${i.details}" class="w-full h-40 object-cover" onerror="this.style.display='none'"></div>`;
                                } else {
                                    detailContent += `<div class="mt-3 p-3 bg-orange-50 text-orange-800 font-bold text-sm rounded-lg border-l-4 border-orange-400">${i.details}</div>`;
                                }
                            }
                            
                            if(hasImage) {
                                detailContent += `<img src="${i.image}" class="expanded-image" />`;
                            }

                            const hasContent = hasDetails || hasImage;

                            return `
                            <div class="bg-stone-50 p-3 rounded-xl border border-stone-100 flex flex-col transition-all ${i.checked ? 'item-checked bg-stone-100 opacity-60' : ''}">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="checkbox-custom" ${i.checked?'checked':''} onchange="window.app.toggleMustBuy('${i.id}', this.checked)">
                                    <div class="flex-grow font-black text-lg text-stone-800 cursor-pointer hover:text-orange-600 transition-colors" onclick="document.getElementById('mb-detail-${i.id}') && document.getElementById('mb-detail-${i.id}').classList.toggle('hidden')">
                                        ${i.name} ${hasContent ? '<i data-lucide="sticky-note" class="w-3 h-3 inline text-stone-400 ml-1 align-top"></i>' : ''}
                                    </div>
                                    <div class="flex items-center">
                                         <button onclick="event.stopPropagation(); window.app.openMustBuyModal('${i.id}')" class="text-stone-300 hover:text-stone-900 p-2"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                         <button onclick="window.app.delDoc('mustbuy', '${i.id}')" class="text-stone-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                ${hasContent ? `<div id="mb-detail-${i.id}" class="hidden ml-9 transition-all">${detailContent}</div>` : ''}
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>`;
            }).join('');
            
            if(window.lucide) window.lucide.createIcons();
        },

        startSlideshow() { 
            let i = 0; 
            const el = document.getElementById('pet-frame'); 
            el.style.backgroundImage = `url(${petPhotos[0]})`;
            
            setInterval(() => { 
                i = (i + 1) % petPhotos.length;
                el.style.backgroundImage = `url(${petPhotos[i]})`; 
            }, 5000); 
        },
        
        openItineraryModal(id=null) {
            const form = document.getElementById('form-itinerary');
            form.reset();
            document.getElementById('itin-id').value = '';
            document.getElementById('btn-del-itin').classList.add('hidden');
            
            if(activeDate && activeDate !== '0') {
                 document.getElementById('itin-date').value = activeDate;
            } else {
                 const firstDate = cachedItinerary.length > 0 ? cachedItinerary[0].date : new Date().toISOString().split('T')[0];
                 document.getElementById('itin-date').value = firstDate;
            }

            if(id) {
                const item = cachedItinerary.find(i => i.id === id);
                if(item) {
                    document.getElementById('itin-id').value = item.id;
                    document.getElementById('itin-date').value = item.date;
                    document.getElementById('itin-time').value = item.time;
                    document.getElementById('itin-end-time').value = item.endTime || '';
                    document.getElementById('itin-cat').value = item.cat;
                    document.getElementById('itin-title').value = item.title;
                    document.getElementById('itin-note').value = item.note;
                    document.getElementById('itin-map').value = item.map;
                    
                    document.getElementById('itin-dep-code').value = item.depCode || 'TPE';
                    document.getElementById('itin-arr-code').value = item.arrCode || 'TYO';
                    document.getElementById('itin-nights').value = item.nights || 1;

                    this.onCatChange(item.cat); 
                    document.getElementById('btn-del-itin').classList.remove('hidden');
                }
            } else {
                 this.onCatChange('æ™¯é»'); 
            }
            document.getElementById('dialog-itinerary').showModal();
        },
        openMemoModal(id=null) {
            const form = document.getElementById('form-memo');
            form.reset();
            document.getElementById('memo-id').value = '';
            if(id) {
                const item = memoList.find(i => i.id === id);
                if(item) {
                    document.getElementById('memo-id').value = item.id;
                    document.getElementById('memo-title').value = item.title;
                    document.getElementById('memo-content').value = item.content;
                }
            }
            document.getElementById('dialog-memo').showModal();
        },
        openWishlistModal(id=null) {
            const form = document.querySelector('#dialog-wishlist form');
            form.reset();
            document.getElementById('wish-id').value = '';
            document.getElementById('wish-image').value = '';
            
            if(id) {
                const item = cachedWishlist.find(i => i.id === id);
                if(item) {
                    document.getElementById('wish-id').value = item.id;
                    document.getElementById('wish-location').value = item.location;
                    document.getElementById('wish-item').value = item.name;
                    document.getElementById('wish-link').value = item.link || '';
                    const radio = form.querySelector(`input[name="wish-type"][value="${item.type}"]`);
                    if(radio) radio.checked = true;
                }
            }
            document.getElementById('dialog-wishlist').showModal();
        },
        openMustBuyModal(id=null) {
            const form = document.querySelector('#dialog-mustbuy form');
            form.reset();
            document.getElementById('mb-id').value = '';
            document.getElementById('mb-image').value = '';

            if(id) {
                const item = cachedMustBuy.find(i => i.id === id);
                if(item) {
                    document.getElementById('mb-id').value = item.id;
                    document.getElementById('mb-category').value = item.category || '';
                    document.getElementById('mb-name').value = item.name;
                    document.getElementById('mb-details').value = item.details || '';
                }
            }
            document.getElementById('dialog-mustbuy').showModal();
        },
        openCalculator() { document.getElementById('dialog-calculator').showModal(); },
        
        async saveMemo() { 
            const id = document.getElementById('memo-id').value;
            const title = document.getElementById('memo-title').value;
            const content = document.getElementById('memo-content').value;
            if(!title) return;
            try { 
                if(id) {
                    await updateDoc(uiApp.getDocRef('memos', id), { title, content });
                } else {
                    await addDoc(uiApp.getCol('memos'), { title, content, createdAt: serverTimestamp() }); 
                }
                document.getElementById('dialog-memo').close();
            } catch(e) { console.error(e); uiApp.showCustomAlert("å„²å­˜å¤±æ•—: " + e.message); } 
        },
        async togglePack(id, state) { try { await updateDoc(uiApp.getDocRef('packing', id), {checked: state}); } catch(e) { console.error(e); } },
        async toggleMustBuy(id, state) { try { await updateDoc(uiApp.getDocRef('mustbuy', id), {checked: state}); } catch(e) { console.error(e); } },
        
        async delDoc(col, id) { 
            try { await deleteDoc(uiApp.getDocRef(col, id)); } 
            catch(e) { console.error(e); uiApp.showCustomAlert("åˆªé™¤å¤±æ•—"); } 
        },
        async deleteItinerary() { 
            const id = document.getElementById('itin-id').value; 
            try { 
                await deleteDoc(uiApp.getDocRef('itinerary', id)); 
                document.getElementById('dialog-itinerary').close(); 
            } catch(e) { console.error(e); uiApp.showCustomAlert("åˆªé™¤å¤±æ•—"); } 
        },
        
        async updateItineraryOrder() {
            const list = document.getElementById('timeline-sortable');
            const items = list.querySelectorAll('.timeline-item');
            const batch = writeBatch(db);
            
            items.forEach((el, index) => {
                const id = el.getAttribute('data-id');
                const ref = uiApp.getDocRef('itinerary', id);
                batch.update(ref, { order: index });
            });
            try { await batch.commit(); } catch(e) { console.error('Order update failed', e); }
        },

        toggleCurrency() {
            this.calcMode = this.calcMode === 'JPY_TWD' ? 'TWD_JPY' : 'JPY_TWD';
            document.getElementById('calc-mode-text').innerText = this.calcMode === 'JPY_TWD' ? 'JPY â†’ TWD' : 'TWD â†’ JPY';
            
            // [Fix] Removed reference to 'calc-input-unit' and 'calc-output-unit' since they were removed in new layout
            // Just update the calc logic
            this.updateCalc();
        },
        calcAppend(n) { 
            if("+-*/".includes(n)) {
                if("+-*/".includes(calcVal.slice(-1))) calcVal = calcVal.slice(0, -1);
            }
            if(calcVal === '0' && n !== '.') calcVal = '';
            calcVal += n; 
            this.updateCalc(); 
        },
        calcDel() { calcVal=calcVal.slice(0,-1)||'0'; this.updateCalc(); },
        calcClear() { calcVal='0'; this.updateCalc(); },
        calcEval() {
             try {
                 const res = new Function('return ' + calcVal)();
                 calcVal = String(Math.round(res * 100) / 100); 
                 this.updateCalc();
             } catch(e) {
                 calcVal = 'Error';
                 setTimeout(() => { calcVal = '0'; this.updateCalc(); }, 1000);
             }
        },
        updateCalc() { 
            document.getElementById('calc-display').value = calcVal;
            try {
                let val = 0;
                if(calcVal && !"+-*/".includes(calcVal.slice(-1))) {
                    val = new Function('return ' + calcVal)();
                }
                let res = 0;
                if (this.calcMode === 'JPY_TWD') res = Math.round(val * currentRate);
                else res = Math.round(val / currentRate);
                document.getElementById('calc-res').innerText = res.toLocaleString(); 
            } catch(e) {
                document.getElementById('calc-res').innerText = '...';
            }
        },
        
        async saveItinerary(e) {
            e.preventDefault();
            const id = document.getElementById('itin-id').value;
            const endTime = document.getElementById('itin-end-time').value;
            const cat = document.getElementById('itin-cat').value;
            
            const data = { 
                date: document.getElementById('itin-date').value, 
                time: document.getElementById('itin-time').value, 
                endTime: endTime,
                cat: cat, 
                title: document.getElementById('itin-title').value, 
                note: document.getElementById('itin-note').value, 
                map: document.getElementById('itin-map').value 
            };

            if(cat === 'èˆªç­') {
                data.depCode = document.getElementById('itin-dep-code').value.toUpperCase();
                data.arrCode = document.getElementById('itin-arr-code').value.toUpperCase();
            } else {
                data.depCode = null; data.arrCode = null;
            }

            if(cat === 'ä½å®¿') {
                data.nights = parseInt(document.getElementById('itin-nights').value) || 1;
            } else {
                data.nights = null;
            }

            try {
                if(id) {
                    await updateDoc(uiApp.getDocRef('itinerary', id), data);
                } else { 
                    if(cat === 'ä½å®¿' && data.nights > 1) {
                         const batch = writeBatch(db);
                         const startDate = new Date(data.date);
                         for(let i=0; i<data.nights; i++) {
                             const newDate = new Date(startDate);
                             newDate.setDate(startDate.getDate() + i);
                             const dateStr = newDate.toISOString().split('T')[0];
                             const newData = {...data, date: dateStr, nights: 1, createdAt: serverTimestamp(), order: 999};
                             const ref = doc(uiApp.getCol('itinerary'));
                             batch.set(ref, newData);
                         }
                         await batch.commit();
                    } else {
                         data.order = cachedItinerary.filter(i => i.date === data.date).length;
                         data.createdAt = serverTimestamp(); 
                         await addDoc(uiApp.getCol('itinerary'), data);
                    }
                }
                document.getElementById('dialog-itinerary').close();
                activeDate = data.date;
            } catch(e) { console.error(e); uiApp.showCustomAlert("å„²å­˜å¤±æ•—"); }
        },
        async savePacking(e) { 
            e.preventDefault(); 
            try { 
                await addDoc(uiApp.getCol('packing'), { name: document.getElementById('pack-name').value, category: document.getElementById('pack-cat').value, checked: false, createdAt: serverTimestamp() });
                document.getElementById('pack-name').value=''; 
                document.getElementById('dialog-packing').close(); 
            } catch(e) { console.error(e); uiApp.showCustomAlert("æ–°å¢å¤±æ•—"); } 
        },
        async saveWishlist(e) {
            e.preventDefault();
            const id = document.getElementById('wish-id').value;
            const type = document.querySelector('input[name="wish-type"]:checked').value;
            const fileInput = document.getElementById('wish-image');
            
            const data = { 
                location: document.getElementById('wish-location').value,
                name: document.getElementById('wish-item').value,
                link: document.getElementById('wish-link').value,
                type: type
            };

            if (fileInput.files.length > 0) {
                try {
                    const base64Img = await compressImage(fileInput.files[0]);
                    data.image = base64Img;
                } catch (err) {
                    console.error("Image compression failed", err);
                    uiApp.showCustomAlert("åœ–ç‰‡è™•ç†å¤±æ•—");
                    return;
                }
            }

            try {
                if(id) {
                    await updateDoc(uiApp.getDocRef('wishlist', id), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(uiApp.getCol('wishlist'), data);
                }
                e.target.reset();
                document.getElementById('dialog-wishlist').close();
            } catch(e) { console.error(e); uiApp.showCustomAlert("å„²å­˜å¤±æ•—"); }
        },
        async saveMustBuy(e) { 
            e.preventDefault(); 
            const id = document.getElementById('mb-id').value;
            const fileInput = document.getElementById('mb-image');

            const data = { 
                category: document.getElementById('mb-category').value,
                name: document.getElementById('mb-name').value, 
                details: document.getElementById('mb-details').value
            };

            if (fileInput.files.length > 0) {
                try {
                    const base64Img = await compressImage(fileInput.files[0]);
                    data.image = base64Img;
                } catch (err) {
                    console.error("Image compression failed", err);
                    uiApp.showCustomAlert("åœ–ç‰‡è™•ç†å¤±æ•—");
                    return;
                }
            }

            try { 
                if(id) {
                    await updateDoc(uiApp.getDocRef('mustbuy', id), data);
                } else {
                    data.checked = false;
                    data.createdAt = serverTimestamp();
                    await addDoc(uiApp.getCol('mustbuy'), data);
                }
                e.target.reset(); 
                document.getElementById('dialog-mustbuy').close(); 
            } catch(e) { console.error(e); uiApp.showCustomAlert("å„²å­˜å¤±æ•—"); } 
        },
        async updateRate() { try { const res=await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); const d=await res.json(); currentRate=d.rates.TWD; uiApp.updateCalc(); } catch(e){} }
    };
    
    window.app = uiApp;

    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('dialog-calculator').addEventListener('close', () => { 
            const view = document.querySelector('.active-view').id; 
            if(view !== 'view-home') document.getElementById('fab-calc').style.display = 'flex'; 
        });
        
        const initAuth = async () => {
            await signInAnonymously(auth);
        };
        initAuth().catch(console.error);

        onAuthStateChanged(auth, (user) => {
            if (user) { uiApp.init(user); } 
            else { 
            }
        });
    });
</script>
</body>
</html>